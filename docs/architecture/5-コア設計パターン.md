# 5. コア設計パターン

## 5.1 Entity-Component-System (ECS)
```typescript
// Entity基底クラス
abstract class Entity {
  id: string;
  position: Vector2D;
  velocity: Vector2D;
  components: Map<string, Component>;
  
  abstract update(deltaTime: number): void;
  abstract render(ctx: CanvasRenderingContext2D): void;
}

// Componentインターフェース
interface Component {
  type: ComponentType;
  update(entity: Entity, deltaTime: number): void;
}

// System基底クラス
abstract class System {
  abstract process(entities: Entity[], deltaTime: number): void;
}
```

## 5.2 イベント駆動アーキテクチャ
```typescript
// イベントバス実装
class EventBus {
  private events: Map<string, Set<EventHandler>>;
  
  on(event: string, handler: EventHandler): void {
    if (!this.events.has(event)) {
      this.events.set(event, new Set());
    }
    this.events.get(event)!.add(handler);
  }
  
  emit(event: string, data?: any): void {
    const handlers = this.events.get(event);
    if (handlers) {
      handlers.forEach(handler => handler(data));
    }
  }
  
  off(event: string, handler: EventHandler): void {
    this.events.get(event)?.delete(handler);
  }
}

// 使用例
eventBus.on('block:destroyed', (data) => {
  particleSystem.createExplosion(data.position);
  scoreManager.addPoints(data.points);
  audioSystem.playSound('blockBreak');
});
```

## 5.3 プラグインアーキテクチャ
```typescript
// プラグインインターフェース
interface Plugin {
  name: string;
  version: string;
  init(game: GameEngine): void;
  destroy(): void;
}

// プラグインマネージャー
class PluginManager {
  private plugins: Map<string, Plugin> = new Map();
  
  register(plugin: Plugin): void {
    this.plugins.set(plugin.name, plugin);
    plugin.init(this.gameEngine);
  }
  
  unregister(name: string): void {
    const plugin = this.plugins.get(name);
    if (plugin) {
      plugin.destroy();
      this.plugins.delete(name);
    }
  }
}

// カスタムパワーアッププラグイン例
class CustomPowerUpPlugin implements Plugin {
  name = 'CustomPowerUp';
  version = '1.0.0';
  
  init(game: GameEngine): void {
    game.powerUpManager.register({
      type: 'custom',
      effect: this.applyEffect,
      duration: 10000
    });
  }
  
  applyEffect(game: GameEngine): void {
    // カスタム効果の実装
  }
  
  destroy(): void {
    // クリーンアップ
  }
}
```
