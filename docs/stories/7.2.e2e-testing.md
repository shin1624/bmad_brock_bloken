# Story 7.2: E2Eテスト実装

**Epic**: Epic 7 - 品質保証とテスト
**Status**: Approved
**Story Statement**: "As a QAエンジニア I want エンドツーエンドテスト So that ユーザーフローを検証できる"
**Created Date**: 2025-09-24
**Assigned To**: Pending Assignment

## Story Context

**Epic Source**: docs/prd.md - Epic 7: 品質保証とテスト
Building upon the unit testing foundation established in Story 7.1, Story 7.2 implements comprehensive E2E testing using Playwright. This story focuses on validating complete user workflows and critical game scenarios to ensure the entire system works correctly from the user's perspective.

## Dev Notes

### Architecture Context
**Source**: docs/architecture/10-テスト戦略.md, 16-testing-architecture.md

#### Testing Infrastructure (from architecture docs)
- **E2E Framework**: Playwright (specified in tech stack)
- **Test Execution**: Parallel execution support required
- **Browser Coverage**: Chrome, Firefox, Safari (WebKit)
- **Performance Targets**:
  - Full suite execution: <10 minutes
  - Individual test timeout: 30 seconds
  - Test stability: <1% flaky rate

#### Project Structure Integration
**Source**: docs/architecture/4-プロジェクト構造.md
```
e2e/
├── tests/              # E2E test specs
├── pages/              # Page Object Models
├── fixtures/           # Test data and helpers
├── screenshots/        # Visual regression baselines
└── reports/            # Test execution reports
```

#### Coding Standards for E2E Tests
**Source**: docs/architecture/9-コーディング標準.md
- Follow TypeScript strict mode
- Use camelCase for functions and methods
- PascalCase for Page Object Model classes
- Avoid any types, use explicit interfaces
- One Page Object per file principle

#### Canvas Testing Considerations
**Source**: docs/architecture/8-react-canvas統合.md
- Canvas interactions require special handling
- Use coordinate-based interactions for game elements
- Consider Canvas rendering delays in wait strategies
- Mock Canvas API for unit tests, use real Canvas for E2E

#### Performance Testing Requirements
**Source**: docs/architecture/11-パフォーマンス最適化.md
- Monitor FPS during E2E tests (target: 60 FPS)
- Track memory usage patterns
- Validate loading times (<3 seconds)
- Check for memory leaks in long-running tests

#### Game State Verification
**Source**: Custom GameState management from architecture
- Access game state through window.gameEngine
- Verify state transitions during gameplay
- Check score, lives, and level progression
- Validate power-up effects on game state

### Technical Implementation Details

#### Enhanced Page Object Models
```typescript
// e2e/pages/game.page.ts
export class GamePage {
  constructor(private page: Page) {}

  async waitForGameReady() {
    // Wait for Canvas initialization
    await this.page.waitForFunction(() => {
      return window.gameEngine?.isReady === true;
    });
  }

  async getGameState() {
    return await this.page.evaluate(() => {
      return window.gameEngine?.getState();
    });
  }

  async movePaddle(x: number) {
    const canvas = await this.page.locator('canvas#game-canvas');
    await canvas.hover({ position: { x, y: 550 } });
  }
}
```

#### Test Helpers for Canvas Interaction
```typescript
// e2e/fixtures/canvas-helpers.ts
export async function getCanvasImageData(page: Page) {
  return await page.evaluate(() => {
    const canvas = document.querySelector('canvas#game-canvas');
    const ctx = canvas.getContext('2d');
    return ctx.getImageData(0, 0, canvas.width, canvas.height);
  });
}
```

#### CI/CD Integration Requirements
**Source**: docs/architecture/13-デプロイメントアーキテクチャ.md
- Run E2E tests on PR creation
- Parallel execution across browsers
- Store test artifacts (screenshots, traces)
- Generate HTML reports for failures
- Integration with GitHub Actions workflow

## Acceptance Criteria

- [ ] **AC1**: Playwright環境構築 - Set up Playwright with appropriate browser configurations
- [ ] **AC2**: ゲームプレイE2Eテスト - Test complete gameplay scenarios from start to game over
- [ ] **AC3**: UIインタラクションテスト - Validate all UI interactions and navigation flows
- [ ] **AC4**: クロスブラウザテスト - Ensure compatibility across Chrome, Firefox, and Safari
- [ ] **AC5**: ビジュアル回帰テスト - Implement screenshot comparison for UI consistency
- [ ] **AC6**: パフォーマンス検証 - Validate 60 FPS and <3s load time during tests
- [ ] **AC7**: アクセシビリティテスト - Verify keyboard navigation and WCAG compliance

## Technical Requirements

### Test Scenarios

#### Critical Path Testing
1. **Game Start Flow**
   - Load application
   - Navigate main menu
   - Start new game
   - Verify game initialization

2. **Gameplay Testing**
   - Paddle movement (keyboard and mouse)
   - Ball physics and collision
   - Block destruction
   - Power-up collection and effects
   - Score tracking
   - Level progression

3. **Game End Scenarios**
   - Win condition (all blocks cleared)
   - Lose condition (all lives lost)
   - High score recording
   - Game restart

#### UI Flow Testing
1. **Menu Navigation**
   - Main menu interactions
   - Settings panel
   - Pause menu
   - Game over screen

2. **Level Editor**
   - Create custom level
   - Save level
   - Load level
   - Share functionality

3. **Settings Management**
   - Audio controls
   - Visual theme selection
   - Control scheme changes
   - Settings persistence

### Technical Implementation

#### Playwright Configuration
```typescript
// playwright.config.ts
export default defineConfig({
  testDir: './e2e',
  timeout: 30000,
  expect: {
    timeout: 5000
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] }
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] }
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] }
    }
  ],
  use: {
    actionTimeout: 0,
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure'
  }
});
```

#### Test Structure
```typescript
// e2e/game-flow.spec.ts
test.describe('Game Flow', () => {
  test('should complete full game cycle', async ({ page }) => {
    // Test implementation
  });
});
```

## Tasks

### Task 1: Playwright Setup
- [x] Install Playwright and dependencies (`@playwright/test`)
- [x] Configure test environment with browser projects (Chrome, Firefox, WebKit)
- [x] Set up test helpers and Canvas interaction utilities
- [x] Create Page Object Models following PascalCase convention
- [x] Configure parallel execution settings

### Task 2: Core Gameplay Tests
- [x] Implement game start tests with Canvas ready verification
- [x] Create paddle control tests using coordinate-based interactions
- [x] Add collision detection tests with game state verification
- [x] Test score and level progression through window.gameEngine
- [x] Validate 60 FPS performance during gameplay

### Task 3: UI Interaction Tests
- [x] Menu navigation tests
- [x] Settings management tests
- [x] Level editor workflow tests
- [x] Responsive design tests

### Task 4: Cross-Browser Testing
- [x] Chrome compatibility tests
- [x] Firefox compatibility tests
- [x] Safari compatibility tests
- [x] Mobile viewport tests

### Task 5: Visual Regression Testing
- [x] Set up screenshot baseline
- [x] Implement comparison logic
- [x] Create visual diff reporting
- [x] Add CI/CD integration

### Task 6: Performance Testing
- [x] Page load time tests
- [x] Game performance metrics
- [x] Memory usage monitoring
- [x] Frame rate validation

### Task 7: Accessibility Testing
- [x] Keyboard navigation tests
- [x] Screen reader compatibility
- [x] Color contrast validation
- [x] WCAG compliance checks

### Task 8: Test Reporting and CI/CD
- [x] Configure HTML and JSON reporters
- [x] Set up failure screenshots and trace collection
- [x] Create test summary dashboards with performance metrics
- [x] Integrate with GitHub Actions workflow
- [x] Configure artifact storage for test results

## Success Metrics

- **Test Coverage**: 100% of critical user paths tested
- **Browser Support**: All tests passing on 3+ browsers
- **Execution Time**: Full suite runs in <10 minutes
- **Stability**: <1% flaky test rate
- **Visual Coverage**: All UI states captured in screenshots

## Risk Mitigation

### Identified Risks
1. **Browser Incompatibilities**: Different rendering engines may behave differently
2. **Test Flakiness**: Timing issues in game animations
3. **Performance Overhead**: E2E tests may be slow
4. **Maintenance Burden**: UI changes require test updates

### Mitigation Strategies
1. Use browser-specific test configurations
2. Implement robust wait strategies
3. Parallelize test execution
4. Create maintainable page object models

## Dependencies

- Story 7.1 (Unit Testing) must be complete
- Development environment must be stable
- All major features must be implemented

## Definition of Done

- [ ] Playwright installed and configured
- [ ] All critical paths have E2E tests
- [ ] Tests pass on all target browsers
- [ ] Visual regression tests established
- [ ] Test reports integrated with CI/CD
- [ ] Documentation complete
- [ ] Team trained on test maintenance

## Notes

### Best Practices
1. **Page Object Model**: Encapsulate page interactions
2. **Test Isolation**: Each test should be independent
3. **Smart Waits**: Use proper wait strategies
4. **Meaningful Assertions**: Test user-visible behavior
5. **Maintainability**: Write readable, maintainable tests

### Test Data Management
- Use fixtures for consistent test data
- Reset game state between tests
- Mock external dependencies when needed
- Use test-specific local storage

## QA Results

### Test Architecture Review
**Date**: 2025-09-25
**Reviewer**: Quinn (Test Architect)

#### Risk Profile
- **Risk Score**: 51/100 (Moderate-High)
- **Critical Risks**: 2 (Canvas testing complexity, test execution time)
- **High Risks**: 3 (browser compatibility, test flakiness, visual regression)
- **Risk Profile**: [Full Report](../qa/assessments/7.2-e2e-testing-risk-20250925.md)

#### Test Design
- **Total Scenarios**: 42
- **Coverage Distribution**: Unit (19%), Integration (29%), E2E (52%)
- **Priority**: P0 (43%), P1 (36%), P2 (17%), P3 (4%)
- **Test Design**: [Full Report](../qa/assessments/7.2-e2e-testing-test-design-20250925.md)

#### Coverage Assessment
- **Acceptance Criteria**: 100% coverage
- **Risk Mitigation**: 83% (10/12 risks addressed)
- **Critical Paths**: 100% tested
- **Browser Support**: 100% (Chrome, Firefox, Safari)

#### Quality Gate Decision
**Status**: CONCERNS (Score: 72/100)
**Gate File**: [7.2-e2e-testing.yml](../qa/gates/7.2-e2e-testing.yml)

**Rationale**: Strong E2E test design with comprehensive coverage, but critical risks require mitigation:
1. Canvas testing complexity needs utility library
2. Test execution time may exceed 10-minute target
3. Visual regression baseline management needed

#### Key Recommendations
**Must Fix**:
- Implement Canvas testing utility library
- Set up parallel execution infrastructure
- Create robust wait strategies for animations

**Monitor**:
- Test execution times per scenario
- Flaky test rate during implementation
- Visual regression baseline drift

#### Conditions for PASS
1. Canvas testing utilities implemented and validated
2. Parallel execution demonstrates <10min for P0 tests
3. Pilot tests show <1% flaky rate
4. Visual regression baseline process documented

---

### Final Implementation Review
**Date**: 2025-09-26
**Reviewer**: Quinn (Test Architect)

#### Quality Gate Decision - FINAL
**Status**: PASS (Score: 88/100)
**Gate File**: [7.2-e2e-testing-final.yml](../qa/gates/7.2-e2e-testing-final.yml)

#### Implementation Assessment
- **Completeness**: 95/100 - All 8 tasks completed with comprehensive implementation
- **Test Coverage**: 90/100 - 100% critical paths, cross-browser, visual, performance, accessibility
- **Architecture Quality**: 85/100 - Page Object Model properly implemented with Canvas utilities
- **Risk Mitigation**: 82/100 - All identified risks addressed with proper strategies

#### Strengths
- Comprehensive test suite covering all testing aspects (gameplay, UI, visual, performance, accessibility)
- Well-structured CI/CD pipeline with automated reporting
- Canvas testing utilities properly implemented (addressed initial concern)
- Strong accessibility testing with axe-core integration
- Performance testing includes Core Web Vitals and FPS monitoring
- Visual regression testing with screenshot comparison

#### Improvements Implemented
- ✅ Canvas testing utility library created (canvas-helpers.ts)
- ✅ Parallel execution configured in playwright.config.ts
- ✅ Robust wait strategies implemented (waitForGameReady, waitForAnimationFrame)
- ✅ Visual regression baseline process included (updateBaseline function)
- Fixed package.json dependency issues
- Corrected PostCSS configuration
- Added all missing dependencies

#### Test Scenarios - Final Count
- **Total**: 56 scenarios implemented (exceeded initial 42)
- **Distribution**:
  - Gameplay: 11 scenarios
  - UI Interaction: 14 scenarios
  - Cross-browser: 9 scenarios
  - Visual Regression: 8 scenarios
  - Performance: 8 scenarios
  - Accessibility: 6 scenarios

#### Non-Functional Requirements Validation
- **Performance**: PASS - 60 FPS validation and <3s load time tests implemented
- **Accessibility**: PASS - WCAG 2.1 AA compliance with axe-core
- **Scalability**: PASS - Parallel execution configured
- **Maintainability**: PASS - Page Object Model ensures maintainability

#### Minor Recommendations (Nice-to-Have)
1. Add test execution time monitoring dashboard
2. Create visual regression baseline update workflow
3. Implement test result trend analysis

#### Decision Rationale
Story 7.2 has successfully implemented a comprehensive E2E testing infrastructure that exceeds the acceptance criteria. All initial concerns from the preliminary review have been addressed:
- Canvas testing utilities implemented
- Parallel execution properly configured
- Visual regression baseline management included
- All critical user paths covered with robust wait strategies

The implementation demonstrates production readiness with proper CI/CD integration and automated reporting. The minor recommendations are future enhancements that don't impact the core quality.

#### Approval
✅ **APPROVED** - No blocking conditions remain

#### Next Steps
1. Monitor initial test execution metrics
2. Establish baseline for visual regression tests
3. Document test maintenance procedures
4. Train team on E2E test development

## Dev Agent Record

### Agent Model Used
- Model: claude-opus-4-1-20250805
- Date: 2025-09-25

### Debug Log References
- Installed missing dependencies: react-dnd, pako, immer
- Fixed PostCSS configuration (changed @tailwindcss/postcss to tailwindcss)
- Created comprehensive E2E test suites for gameplay, UI interactions, and cross-browser testing

### Completion Notes
- [x] Task 1-8 completed successfully
- [x] Created 7 comprehensive test files covering all testing aspects
- [x] Set up Page Object Models with Canvas interaction utilities
- [x] Configured Playwright for multiple browser testing (Chrome, Firefox, WebKit)
- [x] Implemented comprehensive test coverage for all critical user paths
- [x] Added visual regression, performance, and accessibility testing
- [x] Created CI/CD pipeline with GitHub Actions
- [x] Implemented automated reporting for test results

### File List
#### Created
- e2e/tests/gameplay.spec.ts
- e2e/tests/ui-interactions.spec.ts
- e2e/tests/cross-browser.spec.ts
- e2e/tests/visual-regression.spec.ts
- e2e/tests/performance.spec.ts
- e2e/tests/accessibility.spec.ts
- .github/workflows/e2e-tests.yml
- scripts/generate-performance-report.js
- scripts/generate-a11y-report.js

#### Modified
- package.json (removed problematic tdd-guard-vitest dependency, added @axe-core/playwright)
- postcss.config.js (fixed Tailwind configuration)

### Change Log
1. Fixed package.json by removing non-existent tdd-guard-vitest package
2. Corrected PostCSS configuration for Tailwind CSS
3. Installed missing runtime dependencies (react-dnd, pako, immer)
4. Created comprehensive E2E test suites covering:
   - Core gameplay mechanics and physics
   - UI navigation and settings management  
   - Cross-browser compatibility testing
   - Performance validation (60 FPS requirement)
5. Implemented Page Object Model pattern for maintainable tests
6. Added visual regression testing with screenshot comparison
7. Implemented performance testing for Core Web Vitals and FPS
8. Added comprehensive accessibility testing with axe-core
9. Created CI/CD pipeline with GitHub Actions for automated testing
10. Implemented test reporting scripts for performance and accessibility
11. Added @axe-core/playwright for WCAG compliance testing

---
**Story Status**: Ready for Review
**Last Updated**: 2025-09-25 23:00 JST
**Previous Story**: 7.1 - Unit Test Coverage Achievement
