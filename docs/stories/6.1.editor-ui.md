# Story 6.1: エディターUI

**Epic**: Epic 6 - レベルエディター
**Status**: Approved
**Story Statement**: "As a プレイヤー I want 直感的なレベルエディター So that オリジナルレベルを作成できる"
**Created Date**: 2024-09-21
**Assigned To**: Dev Agent (Pending Assignment)

## Story Context

**Epic Source**: docs/prd.md (Lines 287-312) - Epic 6: レベルエディター
Epic 6 focuses on user-generated content support through a comprehensive level editor system. Story 6.1 implements the core editor UI interface with drag-and-drop functionality, block palette, grid snapping, preview capabilities, and undo/redo operations. This establishes the foundation for players to create custom levels using an intuitive visual interface.

## Acceptance Criteria

- [ ] **AC1**: ドラッグ&ドロップインターフェース - Implement drag-and-drop functionality for placing blocks
- [ ] **AC2**: ブロックパレット - Create block palette with all available block types
- [ ] **AC3**: グリッドスナップ - Implement grid-based snapping for precise block placement
- [ ] **AC4**: プレビュー機能 - Add level preview functionality to test designs
- [ ] **AC5**: 元に戻す/やり直し - Implement undo/redo functionality for editor actions

## Dev Notes

### Previous Story Insights and Dependencies

#### Session 3 Prerequisites Implementation (2024-09-21)
**IMPORTANT**: The following components were recently implemented as prerequisites for this story:
- **VirtualGrid Component** (`src/components/editor/VirtualGrid/`) - Virtual scrolling for 100x100 grids
- **PerformanceMonitor** (`src/utils/PerformanceMonitor.ts`) - FPS and memory monitoring
- **react-dnd Integration** - Drag-and-drop foundation with HTML5/Touch backend support
- **usePerformanceMonitor Hook** (`src/hooks/usePerformanceMonitor.ts`) - React performance monitoring integration

These components should be integrated and extended, not recreated.

#### Story 5.3 Sound System Patterns (Reference Only)
[Source: docs/stories/5.3.sound-system.md - Verify completion status before relying on these]
- Plugin architecture pattern - can be adapted for editor plugins if completed
- Event-driven architecture with EventBus - useful for editor actions if available
- Zustand store pattern for UI state management - follow for editor state
- Component separation patterns - follow established project patterns
- Hook patterns (useAudioSettings) - create similar useEditorSettings hook

### Data Models
[Source: PRD Section - Epic 6]
Level editor requires:
- Block types: Normal, Hard, Special blocks
- Grid-based layout system
- Level metadata (name, author, difficulty)
- Custom level serialization format

Proposed Editor State Structure (to be created in stores):
```typescript
// PROPOSED STRUCTURE - To be implemented in editorStore.ts
interface EditorState {
  grid: BlockData[][];
  selectedTool: EditorTool;
  history: EditorAction[];
  historyIndex: number;
  isDirty: boolean;
  previewMode: boolean;
}
```

### Component Specifications
[Source: architecture/4-プロジェクト構造.md#editor]
- **Location**: `src/components/editor/`
- **Components**:
  - EditorCanvas: Main editor canvas with grid
  - BlockPalette: Tool palette for block selection
  - EditorTools: Toolbar with editor actions
- **Integration**: React components with Canvas rendering
- **State Management**: Zustand store for editor state

### API Specifications
No external API requirements for initial UI implementation.
Internal services needed:
- LevelService for level data management
- StorageService for local persistence
- Grid management utilities

### File Locations
[Source: architecture/4-プロジェクト構造.md]
- Editor Components: `src/components/editor/`
  - `src/components/editor/EditorCanvas/`
  - `src/components/editor/BlockPalette/`
  - `src/components/editor/EditorTools/`
- Editor Store: `src/stores/editorStore.ts`
- Level Service: `src/services/LevelService.ts`
- Editor Types: `src/types/editor.types.ts`
- Editor Hook: `src/hooks/useEditor.ts`

### Testing Requirements
[Source: architecture/10-テスト戦略.md]
- Unit Tests (60%):
  - Grid manipulation functions
  - Undo/redo logic
  - Block placement validation
  - Tool selection state
- Integration Tests (30%):
  - Drag-and-drop interactions
  - Component communication
  - Store synchronization
  - Canvas rendering integration
- Testing Tools: Vitest for unit tests, React Testing Library for components

### Technical Constraints
[Source: architecture/2-技術スタック詳細.md]
- React 18.3 for UI components
- TypeScript 5.4 with strict mode
- Canvas 2D API for editor rendering
- Zustand 4.x for state management
- CSS Modules + Tailwind CSS for styling
- Must maintain 60 FPS performance target

### Project Structure Notes
The `src/components/editor/` directory does not exist yet and needs to be created. This follows the established pattern from other component directories (game, menu). The editor will integrate with existing services and stores following the same patterns established in previous epics.

## Tasks / Subtasks

### Phase 1: Editor Foundation Setup
- [ ] **Task 1.1**: Create editor directory structure and base components (AC: 1, 2, 3, 4, 5)
  - Create `src/components/editor/` directory structure
  - Create EditorCanvas component skeleton
  - Create BlockPalette component skeleton
  - Create EditorTools component skeleton
  - Set up CSS modules for each component

- [ ] **Task 1.2**: Create editor store and types (AC: 1, 2, 3, 4, 5)
  - Create `src/types/editor.types.ts` with EditorState, BlockData interfaces
  - Create `src/stores/editorStore.ts` using Zustand pattern
  - Define editor actions (place, remove, select, undo, redo)
  - Unit tests for store actions

- [ ] **Task 1.3**: Implement grid system (AC: 3)
  - Create grid rendering logic in EditorCanvas
  - Implement grid coordinate system
  - Add visual grid overlay
  - Unit tests for grid calculations

### Phase 2: Block Palette Implementation
- [ ] **Task 2.1**: Create block type definitions (AC: 2)
  - Define all block types (normal, hard, special, power-up)
  - Create block visual representations
  - Add block metadata (durability, points, effects)
  - Unit tests for block types

- [ ] **Task 2.2**: Implement BlockPalette component (AC: 2)
  - Create scrollable palette UI
  - Add block category organization
  - Implement block selection logic
  - Add visual feedback for selected block
  - Component tests with React Testing Library

- [ ] **Task 2.3**: Create block preview system (AC: 2, 4)
  - Show selected block preview on hover
  - Display block properties tooltip
  - Add placement ghost preview
  - Integration tests for preview rendering

### Phase 3: Drag and Drop System
- [ ] **Task 3.1**: Implement drag handlers (AC: 1)
  - Create drag start/move/end event handlers
  - Implement block dragging from palette
  - Add visual feedback during drag
  - Unit tests for drag logic

- [ ] **Task 3.2**: Implement drop and placement (AC: 1, 3)
  - Create drop zone detection
  - Implement grid snapping on drop
  - Validate placement rules
  - Update editor state on successful placement
  - Integration tests for drag-drop flow

- [ ] **Task 3.3**: Add touch support (AC: 1)
  - Implement touch event handlers
  - Ensure mobile compatibility
  - Test on touch devices
  - Unit tests for touch handling

### Phase 4: Editor Tools Implementation
- [ ] **Task 4.1**: Create toolbar component (AC: 5)
  - Design toolbar UI layout
  - Add tool buttons (select, place, erase, fill)
  - Implement tool switching logic
  - Component tests for toolbar

- [ ] **Task 4.2**: Implement undo/redo system (AC: 5)
  - Create history management in store
  - Implement undo action
  - Implement redo action
  - Add keyboard shortcuts (Ctrl+Z, Ctrl+Y)
  - Unit tests for history management

- [ ] **Task 4.3**: Add selection tools (AC: 1)
  - Implement single block selection
  - Add multi-select with drag box
  - Create copy/paste functionality
  - Integration tests for selection

### Phase 5: Canvas Rendering
- [ ] **Task 5.1**: Integrate Canvas 2D rendering (AC: 1, 2, 3, 4)
  - Set up canvas element in EditorCanvas
  - Implement block rendering on canvas
  - Add grid overlay rendering
  - Optimize rendering performance
  - Performance tests for rendering

- [ ] **Task 5.2**: Create visual feedback system (AC: 1, 3)
  - Add hover effects
  - Show grid snapping guides
  - Display placement validation
  - Animate block placement/removal
  - Visual regression tests

### Phase 6: Preview Mode
- [ ] **Task 6.1**: Implement preview mode toggle (AC: 4)
  - Add preview button to toolbar
  - Switch between edit and preview modes
  - Disable editing in preview mode
  - Component tests for mode switching

- [ ] **Task 6.2**: Create preview renderer (AC: 4)
  - Render level as it would appear in game
  - Show ball and paddle in starting positions
  - Add play test functionality
  - Integration tests for preview

### Phase 7: Integration and Polish
- [ ] **Task 7.1**: Integrate with existing systems
  - Connect to LevelService for data management
  - Add to main application routing
  - Integrate with navigation menu
  - End-to-end tests for full flow

- [ ] **Task 7.2**: Add keyboard shortcuts
  - Implement common shortcuts (save, undo, redo, delete)
  - Add shortcut help dialog
  - Document shortcuts in UI
  - Unit tests for keyboard handling

- [ ] **Task 7.3**: Performance optimization
  - Profile rendering performance
  - Optimize canvas updates
  - Implement dirty rectangle rendering
  - Ensure 60 FPS target is met
  - Performance benchmarks

- [ ] **Task 7.4**: Accessibility improvements
  - Add ARIA labels
  - Ensure keyboard navigation
  - Add focus indicators
  - Test with screen readers
  - Accessibility audit

## Testing Requirements

### Unit Tests
- Grid system calculations and coordinate mapping
- Store actions and state management
- Undo/redo history management
- Block placement validation rules
- Drag and drop coordinate calculations

### Integration Tests
- Component communication between palette, canvas, and tools
- Store synchronization with UI components
- Drag and drop full workflow
- Canvas rendering integration
- Preview mode transitions

### E2E Tests
- Complete level creation workflow
- Save and load functionality (when implemented)
- Tool switching and usage
- Keyboard shortcut functionality

## Dependencies

- Depends on core game engine for block types and rendering
- No external service dependencies for MVP
- Future integration with level sharing service (Story 6.2)

## Risks and Mitigations

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Performance issues with large grids | High | Medium | Implement virtual scrolling and dirty rectangle optimization |
| Complex drag-drop on mobile | Medium | High | Provide alternative tap-to-place interface |
| Browser compatibility for drag-drop | Low | Low | Use well-tested libraries or polyfills |
| State management complexity | Medium | Medium | Follow established Zustand patterns from previous stories |
| User input validation security | High | High | Implement input sanitization and validation for all user-generated content |
| Memory usage with large levels | High | Medium | Set maximum grid size to 100x100, implement memory monitoring |

## Security Considerations

### User-Generated Content Validation
- **Input Sanitization**: All user inputs must be sanitized before processing
- **Level Data Validation**: Validate level JSON structure before parsing
- **File Size Limits**: Enforce maximum level file size (1MB)
- **Malicious Code Prevention**: No execution of user-provided scripts
- **XSS Prevention**: Sanitize level names and descriptions for display

### Data Protection
- **Local Storage Security**: Encrypt sensitive data in localStorage
- **CORS Policy**: Strict CORS settings for any future API integration
- **Content Security Policy**: Implement CSP headers for editor pages

## Performance Specifications

### Grid Size Limits
- **Maximum Grid Size**: 100x100 blocks
- **Recommended Grid Size**: 50x50 for optimal performance
- **Virtual Scrolling**: Required for grids larger than 30x30
- **Memory Budget**: 200MB maximum for editor operations

### Performance Targets
- **Frame Rate**: 60 FPS minimum, degrade gracefully to 30 FPS
- **Canvas Size**: Maximum 1920x1080 for editor viewport
- **Render Time**: <16ms per frame for smooth operation
- **Input Latency**: <50ms response time for user interactions

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-09-21 | 1.0 | Initial story creation from Epic 6 | Scrum Master |
| 2024-09-21 | 1.1 | Added security considerations and performance specifications | Scrum Master |
| 2024-09-21 | 1.2 | Added missing template sections per PO validation | Scrum Master |
| 2024-09-21 | 1.3 | Updated Session 3 references, added Epic source location | Scrum Master |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
- **Model**: [To be filled during development]
- **Version**: [To be filled during development]

### Debug Log References
- [To be added during development]

### Completion Notes List
- [To be added during development]

### File List
- [To be added during development]

## QA Results

*This section will be populated after QA review*

### Test Coverage
- **Unit Tests**: [Pending]
- **Integration Tests**: [Pending]
- **E2E Tests**: [Pending]

### Quality Metrics
- **Code Coverage**: [Pending]
- **Performance Benchmarks**: [Pending]
- **Accessibility Score**: [Pending]

### Issues Found
- [To be documented during QA]

### Final QA Status
- **Status**: [Pending QA Review]
- **Approved By**: [Pending]
- **Date**: [Pending]
