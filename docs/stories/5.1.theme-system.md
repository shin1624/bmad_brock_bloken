# Story 5.1: テーマシステム

**Epic**: 5. ビジュアルとオーディオ  
**Status**: Draft  
**Story Statement**: "As a プレイヤー I want 複数のビジュアルテーマ So that 好みの見た目でプレイできる"  
**Created Date**: 2025-09-18  
**Assigned To**: Dev Agent  

## Story Context

Epic 5 focuses on enhancing the visual and audio experience of the game through modern retro effects and immersive aesthetics. Story 5.1 implements the theme system foundation that allows players to customize the visual appearance of the game. This includes creating multiple theme variants (neon, pixel, synthwave, minimal) and implementing real-time theme switching functionality.

## Acceptance Criteria

From Epic 5.1 requirements:
- [ ] **AC1**: ネオンテーマ - Neon theme implementation
- [ ] **AC2**: ピクセルテーマ - Pixel theme implementation  
- [ ] **AC3**: シンセウェーブテーマ - Synthwave theme implementation
- [ ] **AC4**: ミニマルテーマ - Minimal theme implementation
- [ ] **AC5**: リアルタイム切り替え - Real-time theme switching

## Dev Notes

### Previous Story Insights
[Source: docs/stories/4.2.basic-powerups.md Dev Agent Record]
- Successfully implemented plugin architecture with PluginManager pattern
- Established visual effects integration with PowerUpEffects.tsx
- Performance optimization patterns with object pooling maintained 60 FPS
- Comprehensive test coverage approach with 95% unit test coverage
- React-Canvas integration patterns for real-time visual updates

### Data Models
[Source: architecture/6-データフローアーキテクチャ.md]
- **UI State Interface**: `selectedTheme: string` in UIState
- **Theme Switching**: `setTheme: (theme: string) => void` method in Zustand store
- **State Management**: Theme preference stored in UIState and persisted via StorageService

### Component Specifications
[Source: architecture/4-プロジェクト構造.md]
- **Theme Files Location**: `src/themes/` directory with individual theme files
  - `src/themes/neon.ts` - Neon theme configuration
  - `src/themes/pixel.ts` - Pixel theme configuration  
  - `src/themes/synthwave.ts` - Synthwave theme configuration
  - `src/themes/minimal.ts` - Minimal theme configuration
- **Theme Plugin**: `src/game/plugins/ThemePlugin.ts` for theme management
- **UI Components**: Theme selector in `src/components/menu/Settings/` directory

### API Specifications
[Source: architecture/5-コア設計パターン.md#5.3 プラグインアーキテクチャ]
- **Plugin Interface**: Theme plugins must implement Plugin interface with name, version, init(), destroy() methods
- **Plugin Registration**: Themes registered through `game.pluginManager.register()` method
- **Event Integration**: Theme changes trigger events through EventBus for real-time updates

### File Locations
[Source: architecture/4-プロジェクト構造.md]
- **Theme Definitions**: `src/themes/{themeName}.ts` files
- **Theme Plugin**: `src/game/plugins/ThemePlugin.ts`
- **Settings UI**: `src/components/menu/Settings/ThemeSelector.tsx`
- **Storage Service**: `src/services/StorageService.ts` for theme persistence
- **UI Store**: `src/stores/uiStore.ts` for theme state management

### Technical Constraints
[Source: architecture/2-技術スタック詳細.md]
- **React 18.3** with TypeScript 5.4 strict mode
- **Canvas 2D API** for visual rendering with theme-specific color schemes
- **Zustand 4.x** for theme state management
- **CSS Modules + Tailwind CSS 3.x** for UI theming
- **60 FPS performance target** must be maintained during theme switches

### Testing Requirements
[Source: architecture/10-テスト戦略.md]
- **Unit Tests (60%)**: Theme plugin functionality, color scheme validation, state management
- **Integration Tests (30%)**: React-Canvas theme integration, real-time switching, settings persistence
- **E2E Tests (10%)**: Complete theme switching user workflows using Playwright
- **Test Location**: Co-located test files using `.test.ts` or `.test.tsx` extensions

### Project Structure Notes
Theme system aligns with established plugin architecture from Story 4.2. Theme files follow the modular structure in `src/themes/` directory. Theme selection UI integrates with existing Settings component structure.

## Tasks / Subtasks

### Task 1: Create Theme Data Models and Types (AC: 1,2,3,4)
- [ ] Define `ThemeConfig` interface in `src/types/ui.types.ts`
- [ ] Create color scheme type definitions for all theme variants
- [ ] Add theme-specific visual properties (gradients, shadows, effects)
- [ ] Unit test: Theme configuration validation

### Task 2: Implement Individual Theme Files (AC: 1,2,3,4)
- [ ] Create `src/themes/neon.ts` with neon color scheme and visual effects
- [ ] Create `src/themes/pixel.ts` with retro pixel art styling
- [ ] Create `src/themes/synthwave.ts` with 80s synthwave aesthetics
- [ ] Create `src/themes/minimal.ts` with clean minimal design
- [ ] Unit test: Each theme configuration exports valid ThemeConfig

### Task 3: Develop Theme Plugin System (AC: 5)
- [ ] Create `src/game/plugins/ThemePlugin.ts` implementing Plugin interface
- [ ] Add theme registration and management methods
- [ ] Implement Canvas rendering context theme application
- [ ] Add real-time theme switching without game interruption
- [ ] Unit test: Theme plugin initialization and switching functionality

### Task 4: Build Theme Selector UI Component (AC: 5)
- [ ] Create `src/components/menu/Settings/ThemeSelector.tsx`
- [ ] Add theme preview thumbnails for each option
- [ ] Implement real-time preview functionality
- [ ] Integrate with existing Settings menu structure
- [ ] Unit test: Theme selector component rendering and interaction

### Task 5: Update State Management for Themes (AC: 5)
- [ ] Extend `src/stores/uiStore.ts` with theme state management
- [ ] Add theme persistence to `src/services/StorageService.ts`
- [ ] Implement theme preference loading on app initialization
- [ ] Add theme validation and fallback to default theme
- [ ] Unit test: Theme state management and persistence

### Task 6: Integrate Themes with Canvas Rendering (AC: 1,2,3,4,5)
- [ ] Update `src/game/rendering/Renderer.ts` to apply theme colors
- [ ] Add theme-aware particle effects for different visual styles
- [ ] Implement theme-specific background and UI element styling
- [ ] Ensure theme changes apply immediately to all visual elements
- [ ] Integration test: Canvas rendering with all theme variants

### Task 7: Add Theme Integration with React Components (AC: 5)
- [ ] Update HUD components to use theme-aware styling
- [ ] Add theme CSS custom properties for React component theming
- [ ] Implement theme-aware animations and transitions
- [ ] Update existing UI components to support theme variations
- [ ] Integration test: React component theme integration

### Task 8: Performance Optimization and Testing (AC: 5)
- [ ] Optimize theme switching performance to maintain 60 FPS
- [ ] Add performance monitoring for theme changes
- [ ] Implement efficient theme asset loading and caching
- [ ] Profile memory usage during theme switches
- [ ] Performance test: Theme switching performance validation

## Testing

### Testing Standards
[Source: architecture/10-テスト戦略.md]
- **Test File Location**: Co-located with source files using `.test.ts` or `.test.tsx` extensions
- **Testing Frameworks**: Vitest for unit tests, React Testing Library for component tests, Playwright for E2E
- **Coverage Target**: 60% unit tests, 30% integration tests, 10% E2E tests
- **Test Patterns**: Describe blocks for component grouping, it blocks for specific behaviors
- **Performance Testing**: Theme switching must complete within 16ms (1 frame) to maintain 60 FPS

### Story-Specific Testing Requirements
- Theme configuration validation for all four theme variants
- Real-time theme switching without visual artifacts or performance degradation
- State persistence across browser sessions
- Canvas rendering integrity with theme-specific color schemes
- UI component theme integration across all menu and game interfaces

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-18 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

> This section will be populated by the Dev Agent during implementation

## QA Results

> This section will be populated by the QA Agent after implementation review