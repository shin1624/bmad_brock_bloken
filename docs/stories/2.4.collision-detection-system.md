# Story 2.4: 衝突検出システム

## Status
Approved

## Story
**As a** プレイヤー  
**I want** 正確な衝突判定  
**So that** 公平なゲームプレイができる

## Acceptance Criteria

1. AABB（Axis-Aligned Bounding Box）衝突検出実装
2. ボール-パドル衝突（反射角計算含む）
3. ボール-ブロック衝突（ブロック破壊処理含む）
4. 複数同時衝突の優先順位処理
5. 貫通バグの防止（フレーム間移動距離考慮）

## Tasks / Subtasks

- [ ] **Task 1: 衝突検出アルゴリズム拡張** (AC: 1, 2, 3)
  - [ ] CollisionDetectorクラスを拡張し、統合的なAABB衝突検出システム実装 (`src/game/physics/CollisionDetector.ts`)
  - [ ] Ball-Paddle反射角計算の精密化（打点位置による角度変化）
  - [ ] Ball-Block衝突検出の最適化と複数ブロック同時処理
  - [ ] 衝突応答システム実装（速度ベクトル調整、位置補正）
  - [ ] 衝突イベント配信の拡張（詳細情報付きEventBus統合）

- [ ] **Task 2: 優先順位衝突処理システム** (AC: 4)
  - [ ] CollisionPriorityManagerクラス作成 (`src/game/systems/CollisionPriorityManager.ts`)
  - [ ] パドル > ブロック > 壁の優先順位実装
  - [ ] 同時衝突時の最適解決アルゴリズム
  - [ ] 衝突解決順序の最適化（最短距離優先）
  - [ ] EventBus統合（'collision:resolved', 'collision:priority'）

- [ ] **Task 3: 連続衝突検出（CCD）システム** (AC: 5)
  - [ ] ContinuousCollisionDetectorクラス作成 (`src/game/physics/ContinuousCollisionDetector.ts`)
  - [ ] フレーム間移動軌跡による貫通防止アルゴリズム
  - [ ] 高速移動時の衝突予測システム
  - [ ] タイムステップ細分化による精度向上
  - [ ] デバッグ可視化機能（軌跡表示、衝突予測点）

- [ ] **Task 4: 衝突デバッグシステム** (AC: 全般)
  - [ ] CollisionDebuggerクラス作成 (`src/game/debug/CollisionDebugger.ts`)
  - [ ] F6キーによる衝突ボックス可視化機能
  - [ ] 衝突軌跡とリアルタイム情報表示
  - [ ] 性能メトリクス表示（衝突検出処理時間、検出精度）
  - [ ] デバッグ設定のON/OFF切り替え機能

- [ ] **Task 5: パフォーマンス最適化システム** (AC: 全般)
  - [ ] 空間分割システム実装検討 (`src/game/physics/SpatialHash.ts`)
  - [ ] 衝突検出の計算量最適化（O(n²)からO(n)へ）
  - [ ] フレーム予算内での衝突検出完了保証
  - [ ] メモリ使用量最適化（衝突キャッシュシステム）
  - [ ] 60FPS維持のためのパフォーマンス監視

- [ ] **Task 6: React統合と UI制御** (AC: 全般)
  - [ ] useCollisionSystemカスタムフック作成 (`src/hooks/useCollisionSystem.ts`)
  - [ ] 衝突情報のReact状態管理統合
  - [ ] デバッグUI表示コンポーネント統合
  - [ ] 衝突フィードバック（振動、音声、視覚効果）
  - [ ] 設定画面での衝突検出精度調整機能

- [ ] **Task 7: ユニットテストと統合テスト** (AC: 全般)
  - [ ] CollisionDetectorの拡張ユニットテスト（複雑な衝突シナリオ）
  - [ ] CollisionPriorityManagerのユニットテスト（優先順位処理）
  - [ ] ContinuousCollisionDetectorのユニットテスト（貫通防止）
  - [ ] 統合テスト（複数オブジェクト同時衝突シナリオ）
  - [ ] パフォーマンステスト（大量衝突処理、メモリ使用量）
  - [ ] E2Eテスト（実ゲームプレイでの衝突検出精度）
  - [ ] テストカバレッジ >90% 達成

## Dev Notes

### Previous Story Insights - Enhanced
[Source: Story 2.3 Block System Dev Agent Record & QA Assessment]

**確立済み技術基盤:**
- CollisionDetector基盤完成 - Ball-Block AABB衝突検出既実装
- EventBus統合パターン確立 - 衝突イベント配信システム拡張可能
- ObjectPool パターン実証済み - 衝突計算結果キャッシュに適用可能
- 60FPS維持最適化確立 - 衝突検出処理時間予算内実行必要
- Entity基底クラス継承確立 - 新衝突系Entityクラスに直接適用

**技術的課題と解決済み項目:**
- AABB衝突基本実装完了 - 精度向上とパフォーマンス最適化に集中
- 複数ブロック同時衝突処理実装済み - パドル・壁との統合が主要課題
- 連続衝突検出（CCD）未実装 - 高速ボール対応で新規導入必要
- 空間分割最適化未実装 - 大規模衝突検出でのパフォーマンス向上

### Technical Architecture Context

#### Enhanced Collision Detection System
[Source: docs/architecture/5-コア設計パターン.md#5.1 + Story 2.3 Implementation]
```typescript
// 統合衝突検出システム拡張パターン
class CollisionDetector {
  // 既実装: Ball-Block AABB detection
  static checkBallBlockCollision(ball, block, deltaTime): CollisionInfo
  
  // 新規拡張: 統合衝突検出
  static checkAllCollisions(ball, entities, deltaTime): CollisionResult[]
  static resolveCollisionPriority(collisions): CollisionResolution
  static applyContinuousCollisionDetection(trajectory): SafePosition
}
```

#### Performance Optimization Requirements
[Source: docs/architecture/11-パフォーマンス最適化.md]
```typescript
// 空間分割による衝突最適化
class SpatialHash {
  private grid: Map<string, Set<Entity>>;
  private cellSize: number; // 推奨: 100px (ブロックサイズベース)
  
  insert(entity: Entity): void; 
  query(bounds: Rectangle): Entity[];
  // O(n²) → O(n) 衝突検出最適化
}
```

#### Event-Driven Collision Integration
[Source: docs/architecture/5-コア設計パターン.md#5.2]
```typescript
// 衝突イベント設計拡張
eventBus.on('collision:detected', (data) => {
  collisionPriorityManager.addCollision(data);
  debugger.visualizeCollision(data.contactPoint);
  performanceMonitor.recordCollisionTime(data.processingTime);
});

eventBus.on('collision:resolved', (data) => {
  audioSystem.playCollisionSound(data.type);
  gameStateManager.updateGameState(data.stateChanges);
});
```

#### File Structure Planning
[Source: docs/architecture/4-プロジェクト構造.md + Story 2.3 Patterns]
- **Physics**: `src/game/physics/CollisionDetector.ts` - AABB基盤拡張
- **Physics**: `src/game/physics/ContinuousCollisionDetector.ts` - CCD新規実装
- **Physics**: `src/game/physics/SpatialHash.ts` - 空間分割最適化
- **Systems**: `src/game/systems/CollisionPriorityManager.ts` - 優先順位処理
- **Debug**: `src/game/debug/CollisionDebugger.ts` - 衝突可視化
- **Hooks**: `src/hooks/useCollisionSystem.ts` - React統合

### Data Models and Type Definitions
[Source: Existing src/types/game.types.ts + Enhanced Requirements]

**Collision System Types:**
```typescript
interface CollisionInfo {
  collided: boolean;
  contactPoint?: Vector2D;
  normal: Vector2D;
  penetration: number;
  relativeVelocity: Vector2D;
  processingTime?: number; // パフォーマンス監視用
}

interface CollisionResult {
  entityA: Entity;
  entityB: Entity;
  collisionInfo: CollisionInfo;
  priority: CollisionPriority;
  timestamp: number;
}

enum CollisionPriority {
  Paddle = 1,    // 最高優先度
  Block = 2,     // 中優先度
  Wall = 3       // 最低優先度
}

interface ContinuousCollisionData {
  trajectory: LineSegment;
  timeOfImpact: number;
  safePosition: Vector2D;
  collisionPredicted: boolean;
}
```

**Spatial Hash Configuration:**
```typescript
interface SpatialHashConfig {
  cellSize: number;     // 100px (ブロック+パディング)
  worldBounds: Rectangle;
  maxEntitiesPerCell: number; // 16 (予想最大数)
}
```

### API Specifications
[Source: EventBus patterns + Story 2.3 Integration]

**Collision Events:**
- `collision:detected` - 衝突検出時（優先順位処理前）
- `collision:resolved` - 衝突解決後（速度・位置更新後）
- `collision:priority` - 優先順位決定時
- `collision:ccd:activated` - 連続衝突検出発動時
- `collision:performance:warning` - 処理時間超過警告

**Debug Events:**
- `debug:collision:toggle` - F6キー衝突表示切り替え
- `debug:collision:visualize` - 衝突ボックス表示更新

### Component Specifications
[Source: React-Canvas integration patterns from Story 2.2/2.3]

**Custom Hooks:**
- `useCollisionSystem()` - 衝突検出統合、デバッグ制御
- `useCollisionDebug()` - デバッグ情報表示、設定管理
- `useCollisionPerformance()` - パフォーマンス監視、メトリクス

### Technical Constraints
[Source: Performance requirements + Story 2.3 achievements]
- **Frame Budget**: <5ms衝突検出処理時間（60FPS維持）
- **Memory Usage**: <50MB追加（空間分割データ構造含む）
- **Detection Accuracy**: >99% 衝突検出精度（Epic 2要件）
- **Collision Throughput**: 最大200同時衝突/frame対応

### Integration Points
[Source: Story 2.1, 2.2, 2.3実装完了項目]
- **Ball Physics**: Story 2.2の速度計算システムとCCD統合
- **Block System**: Story 2.3のブロック破壊処理と衝突優先順位統合  
- **Paddle Control**: Story 2.1のパドル制御と反射角計算統合
- **Game State**: 既存GameStateManagerに衝突統計追加

### Performance Optimization Strategy
[Source: docs/architecture/11-パフォーマンス最適化.md + Story 2.3 ObjectPool]
- **空間分割**: セルサイズ100px、エンティティ数予測ベース最適化
- **衝突キャッシュ**: 前フレーム結果利用による計算削減
- **フレーム予算**: 処理時間5ms制限、超過時品質調整
- **メモリプール**: 衝突結果オブジェクトの再利用パターン適用

### Testing Strategy Requirements
[Source: docs/architecture/10-テスト戦略.md + Story 2.3 Test Patterns]
- **Unit Tests (60%)**: CollisionDetector, CCD, SpatialHash個別検証
- **Integration Tests (30%)**: 複数衝突シナリオ、優先順位処理検証
- **E2E Tests (10%)**: 実ゲームプレイでの衝突精度検証
- **Performance Tests**: 大量衝突負荷テスト、メモリリーク検証
- **Coverage Target**: >90% for collision detection core logic

**Test File Locations:**
- `src/game/physics/__tests__/CollisionDetector.test.ts`
- `src/game/physics/__tests__/ContinuousCollisionDetector.test.ts`
- `src/game/systems/__tests__/CollisionPriorityManager.test.ts`
- `src/game/debug/__tests__/CollisionDebugger.test.ts`
- `src/hooks/__tests__/useCollisionSystem.test.tsx`

**Testing Framework:**
- **Unit Tests**: Vitest with collision scenario validation
- **Integration Tests**: Canvas collision simulation with mocking
- **Performance Tests**: Benchmark collision detection throughput
- **E2E Tests**: Playwright for gameplay collision accuracy

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-13 | 1.0 | Initial story draft creation with Epic 2.4 requirements and comprehensive context from Story 2.3 collision detection foundation | Bob (Scrum Master) |
| 2025-09-13 | 1.1 | Story approved for implementation - QA analysis complete (Risk: 79/100, Test Design: 27 scenarios) | BMad Master |