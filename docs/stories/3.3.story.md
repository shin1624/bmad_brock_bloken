# Story 3.3: 一時停止システム

**Epic**: 3. UI/UX システム  
**Status**: Approved  
**Story Statement**: "As a プレイヤー I want ゲームを一時停止できる So that 休憩できる"  
**Created Date**: 2025-01-15  
**Assigned To**: Dev Agent  

## Story Context

Epic 3 focuses on building a comprehensive UI/UX system following the layered architecture established in Stories 1.x and 2.x. Story 3.3 implements the pause system that allows players to temporarily suspend gameplay, displaying a pause menu overlay with options to resume, access settings, or return to the main menu. This builds on the solid foundation established in Story 3.1's main menu system and Story 3.2's HUD interface.

## Acceptance Criteria

From Epic 3.3 requirements:
- [x] **AC1**: ESCキーで一時停止 - ESC key triggers pause functionality
- [x] **AC2**: 一時停止メニュー表示 - Pause menu overlay display
- [x] **AC3**: 再開オプション - Resume game option
- [x] **AC4**: メインメニューへ戻る - Return to main menu option
- [x] **AC5**: 設定へのアクセス - Settings access from pause menu

## Technical Requirements

### Performance Standards
- Pause menu render time <16ms (60FPS compliance)
- Pause state transition <100ms
- Menu animation duration <300ms
- Memory footprint <2MB for pause menu assets
- No impact on underlying game state persistence

### Accessibility Standards
- WCAG 2.1 AA compliance for pause menu elements
- Keyboard navigation support (Tab, Enter, ESC)
- Screen reader compatibility
- High contrast mode support
- Color-blind friendly indicators

## Tasks/Subtasks

### Task 1: Pause State Management System
**Acceptance Criteria**: AC1, AC3
- [x] Create pause state in UI store (Zustand)
- [x] Implement ESC key event handling with useGameInput hook
- [x] Add pause/resume functionality to GameStateManager integration
- [x] Create pause state persistence for proper game state suspension
- [x] Add pause state validation and error handling

### Task 2: Pause Menu UI Component ✅
**Acceptance Criteria**: AC2, AC3, AC4, AC5
- [x] Create `PauseMenu.tsx` component (`src/components/game/PauseMenu/`)
- [x] Implement modal overlay with backdrop blur
- [x] Create responsive menu layout with consistent design system
- [x] Add menu item components (Resume, Settings, Main Menu)
- [x] Integrate with existing theme system from Story 3.1

### Task 3: Pause Menu Navigation System ✅
**Acceptance Criteria**: AC3, AC4, AC5
- [x] Implement keyboard navigation (Arrow keys, Tab, Enter)
- [x] Add focus management and visual focus indicators
- [x] Create menu item selection and action handling
- [x] Add menu animation transitions (fade in/out)
- [x] Integrate with GameContainer component routing

### Task 4: Game State Integration ✅
**Acceptance Criteria**: AC1, AC3
- [x] Pause GameEngine and game loop suspension
- [x] Maintain game state integrity during pause
- [x] Handle pause state across React-Canvas bridge
- [x] Add pause state synchronization with HUD visibility
- [x] Implement proper cleanup on menu exit

### Task 5: Settings Integration ✅
**Acceptance Criteria**: AC5
- [x] Connect to existing Settings component from Story 3.1
- [x] Add settings overlay within pause menu context
- [x] Implement settings state persistence during pause
- [x] Add settings close handling back to pause menu
- [x] Integrate volume and theme controls

### Task 6: Main Menu Navigation ✅
**Acceptance Criteria**: AC4
- [x] Add confirmation dialog for "Return to Main Menu"
- [x] Implement game state cleanup and reset
- [x] Handle navigation to MainMenu component
- [x] Add progress loss warning for unsaved progress
- [x] Integrate with existing menu system from Story 3.1

### Task 7: Testing and Accessibility ✅
**Acceptance Criteria**: All ACs, Accessibility Standards
- [x] Pause menu component unit tests (render, navigation, actions)
- [x] Keyboard accessibility tests (Tab navigation, ESC handling)
- [x] Integration tests with GameStateManager pause functionality
- [x] Performance tests for menu animation and rendering
- [x] Accessibility compliance tests (axe-core integration)
- [x] Achieve >90% test coverage

## Dev Notes

### Previous Story Insights

**成功パターン from Story 3.2:**
- **Component Architecture**: `src/components/game/` structure established and working well - apply to PauseMenu
- **State Management Integration**: GameStateManager bridge patterns proven with HUD - apply to pause state management
- **Custom Hooks**: `useHUD` pattern successful for React-Canvas integration - create `usePauseMenu` hook
- **Overlay Positioning**: HUD overlay positioning system working perfectly - reuse for pause menu backdrop
- **Animation Performance**: GPU-optimized animations implemented successfully - apply to menu transitions
- **Accessibility**: WCAG compliance patterns established - apply to pause menu navigation
- **Testing Strategy**: Comprehensive test coverage achieved (97.7%) - maintain standards for pause menu

**技術的課題と解決済み項目 from Story 3.2:**
- **React-Canvas Integration**: GameStateManager integration patterns established - extend for pause functionality
- **Event Handling**: ESC key and input management patterns available from useGameInput hooks
- **Component Communication**: Parent-child component communication patterns proven - use for menu navigation
- **State Persistence**: localStorage patterns implemented - apply to pause state and progress
- **Performance Optimization**: Component render optimization achieved - apply to modal overlays

### Technical Architecture Context

#### Component Structure
[Source: docs/architecture/4-プロジェクト構造.md#components]
```
src/components/game/
├── HUD/                    # Completed in Story 3.2
├── PauseMenu/              # NEW - Story 3.3
│   ├── PauseMenu.tsx       # Main pause menu container
│   ├── PauseOverlay.tsx    # Backdrop and modal wrapper
│   ├── MenuButton.tsx      # Individual menu action buttons
│   └── index.ts            # Barrel exports
└── GameCanvas/             # Integration point
```

#### State Management Integration
[Source: docs/architecture/6-データフローアーキテクチャ.md#状態管理戦略]
```typescript
// UI State Extension for Pause System
interface UIState {
  currentScreen: Screen;
  isPaused: boolean;           // NEW - pause state
  pauseMenuVisible: boolean;   // NEW - menu visibility
  selectedTheme: string;
  volume: number;
  
  setScreen: (screen: Screen) => void;
  togglePause: () => void;     // NEW - pause toggle
  showPauseMenu: () => void;   // NEW - menu display
  hidePauseMenu: () => void;   // NEW - menu hide
}

// GameStateManager Pause Integration
class GameStateManager {
  private isPaused: boolean = false;
  
  pause(): void {
    this.isPaused = true;
    this.gameLoop.pause();           // Suspend game loop
    this.notifySubscribers();
  }
  
  resume(): void {
    this.isPaused = false;
    this.gameLoop.resume();          // Resume game loop
    this.notifySubscribers();
  }
  
  isPauseState(): boolean {
    return this.isPaused;
  }
}
```

#### Custom Hook Pattern
[Source: docs/architecture/8-react-canvas統合.md#カスタムフック]
```typescript
// usePauseMenu Hook Design
function usePauseMenu() {
  const { isPaused, togglePause, showPauseMenu, hidePauseMenu } = useGameStore();
  const [isVisible, setIsVisible] = useState(false);
  
  // ESC key handling
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        togglePause();
        setIsVisible(!isPaused);
      }
    };
    
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isPaused, togglePause]);
  
  const resumeGame = useCallback(() => {
    togglePause();
    hidePauseMenu();
    setIsVisible(false);
  }, [togglePause, hidePauseMenu]);
  
  const returnToMenu = useCallback(() => {
    // Add confirmation logic and cleanup
    hidePauseMenu();
    // Navigate to main menu
  }, [hidePauseMenu]);
  
  return {
    isPaused,
    isVisible,
    resumeGame,
    returnToMenu,
    showSettings: () => {/* Settings integration */}
  };
}
```

#### Animation System Integration
[Source: Epic 3 Architecture + Story 3.2 GPU Animation Patterns]
```css
/* PauseMenu.module.css - GPU Optimized Animations */
.pauseOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(8px);
  z-index: 1000;
  
  animation: fadeIn 300ms ease-out;
  will-change: opacity, backdrop-filter;
}

.pauseMenu {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.95);
  background: var(--menu-background);
  border-radius: 12px;
  padding: 2rem;
  
  animation: slideIn 300ms ease-out forwards;
  will-change: transform, opacity;
}

@keyframes fadeIn {
  from { opacity: 0; backdrop-filter: blur(0); }
  to { opacity: 1; backdrop-filter: blur(8px); }
}

@keyframes slideIn {
  from { 
    transform: translate(-50%, -50%) scale(0.95);
    opacity: 0;
  }
  to { 
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
}
```

#### Input Integration Pattern
[Source: docs/architecture/8-react-canvas統合.md#入力処理フック]
```typescript
// Game Input Integration for Pause System
function useGameInput(engine: GameEngine | null) {
  const { togglePause } = useGameStore();
  
  useEffect(() => {
    if (!engine) return;
    
    const handleKeyDown = (e: KeyboardEvent) => {
      // Pause handling
      if (e.key === 'Escape') {
        e.preventDefault();
        togglePause();
        return;
      }
      
      // Only pass other inputs to engine when not paused
      if (!engine.isPaused()) {
        engine.handleInput('keydown', e.key);
      }
    };
    
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [engine, togglePause]);
}
```

### Integration Points

#### GameStateManager Integration
[Source: docs/architecture/6-データフローアーキテクチャ.md]
- Pause/resume methods for game loop control
- State preservation during pause
- Event notification to UI subscribers

#### Menu System Integration  
[Source: Story 3.1 MainMenu patterns]
- Consistent button styling and behavior
- Theme system integration
- Navigation state management

#### HUD Integration
[Source: Story 3.2 HUD implementation]
- HUD visibility control during pause
- Overlay z-index management
- State synchronization patterns

### Testing Requirements
[Source: docs/architecture/10-テスト戦略.md]

**Unit Tests (60%)**:
- PauseMenu component rendering and props
- Menu button interactions and callbacks
- usePauseMenu hook state management
- ESC key handling and event management

**Integration Tests (30%)**:
- Pause menu with GameStateManager integration
- Menu navigation and routing
- Settings integration from pause menu
- Game state preservation during pause

**E2E Tests (10%)**:
- Complete pause/resume workflow
- ESC key functionality
- Menu navigation accessibility
- Cross-browser pause functionality

### Performance Considerations
[Source: Epic 3 Performance Requirements]
- Menu render time <16ms target
- Animation performance with GPU acceleration
- Memory management for overlay components
- No impact on game state during pause

### Security Considerations
[Source: docs/architecture/12-セキュリティ考慮事項.md]
- Input validation for menu actions
- State validation during pause transitions
- No sensitive data exposure in pause state

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-15 | 1.0 | Initial story creation | BMad Master |

## QA Results

### Quality Assessment Summary
**Review Date**: 2025-09-15  
**Reviewer**: Quinn (Test Architect)  
**Quality Gate Decision**: PASS  
**Quality Score**: 88/100  
**Implementation Readiness**: ✅ Ready with Risk Monitoring

### Requirements Traceability
**AC Coverage**: 5/5 acceptance criteria fully mapped to technical solutions
- **AC1 (ESCキーで一時停止)**: ✅ GameLoop.pause() + input handler integration verified
- **AC2 (一時停止メニュー表示)**: ✅ Modal overlay patterns from Story 3.2 HUD applicable
- **AC3 (再開オプション)**: ✅ GameLoop.resume() + UI state management ready
- **AC4 (メインメニューへ戻る)**: ✅ Navigation patterns from Story 3.1 established
- **AC5 (設定へのアクセス)**: ✅ Settings component integration architecture verified

### Technical Architecture Assessment
**Architecture Score**: 90/100
- ✅ **Foundation Strength**: GameLoop pause/resume methods implemented and tested
- ✅ **UI State Management**: isPauseMenuOpen patterns established in UIStore
- ✅ **Component Architecture**: Proven overlay patterns from successful HUD (Story 3.2)
- ✅ **Integration Readiness**: React-Canvas bridge patterns proven
- ⚠️ **Modal Coordination**: Z-index hierarchy needs planning for Settings overlay
- ⚠️ **Event Management**: ESC key priority coordination required

### Test Strategy Validation
**Testing Coverage Plan**: 90%+ target (following Story 3.2 success patterns)
- **Unit Tests**: 42 tests planned (60% of coverage)
  - PauseMenu component rendering and interaction testing
  - usePauseMenu hook state management validation
  - ESC key handling and event management testing
- **Integration Tests**: 21 tests planned (30% of coverage)
  - GameStateManager pause integration testing
  - Settings and navigation integration validation
- **E2E Tests**: 7 tests planned (10% of coverage)
  - Complete pause/resume workflow testing
  - Cross-browser and accessibility validation

### Risk Assessment
**Risk Profile**: Manageable (6 risks identified, 0 critical blockers)

**HIGH PRIORITY RISKS**:
- **ARCH-001**: Modal z-index conflicts between pause menu and settings overlay
  - *Mitigation*: Establish z-index hierarchy (pause: 1000, settings: 1100)
- **INPUT-001**: ESC key event propagation conflicts
  - *Mitigation*: Event.preventDefault() and proper handler priority

**MEDIUM RISKS**:
- **STATE-001**: Game pause state vs UI menu visibility synchronization
  - *Mitigation*: EventBus centralized state management
- **PERF-001**: Performance impact on resume due to deltaTime reset
  - *Mitigation*: GameLoop.resume() already handles timing reset

**MONITORING REQUIRED**:
- Japanese text responsive design in smaller viewports
- Settings state persistence during pause menu lifecycle

### NFR Validation Results
**Performance**: ✅ PASS
- <16ms render target achievable with GPU animation patterns from Story 3.2
- <100ms pause state transition feasible with existing GameLoop architecture
- <2MB memory footprint achievable (similar to HUD complexity)

**Accessibility**: ✅ PASS  
- WCAG 2.1 AA compliance patterns established in Story 3.1/3.2
- Keyboard navigation (Tab, Enter, ESC) patterns proven
- Screen reader and high contrast support ready

**Security**: ✅ PASS
- Input validation through existing event handling patterns
- React XSS protections in place for menu content
- No sensitive data exposure in pause state (read-only UI)

**Maintainability**: ✅ PASS
- Leverages proven architectural patterns from successful stories
- TypeScript strict mode compliance maintained
- Clean component architecture following established conventions

### Success Indicators
**Confidence Level**: HIGH (builds on Story 3.1/3.2 success patterns)
- Story 3.2 achieved 97.7% test coverage with PASS quality gate
- GameLoop and UIStore foundations already proven in production
- React-Canvas integration patterns established and validated
- Japanese localization context properly addressed

### Implementation Recommendations
**IMMEDIATE ACTIONS**:
1. Define z-index hierarchy constants for modal layering system
2. Plan ESC key event handling priority and propagation order
3. Establish EventBus patterns for pause state synchronization

**MONITORING DURING IMPLEMENTATION**:
1. Modal overlay interaction testing (pause + settings)
2. Performance validation of menu animations and transitions
3. Japanese text overflow testing in responsive layouts
4. Game state integrity validation during pause/resume cycles

### Quality Gate Decision: PASS ✅
**Rationale**: Exceptional architectural foundation with proven patterns from successful Story 3.1 (MainMenu) and Story 3.2 (HUD). All acceptance criteria mapped to technical solutions. Risk profile is manageable with clear mitigation strategies. Ready for implementation with active risk monitoring.

**Expected Outcome**: High-quality implementation matching Story 3.2 standards (97%+ test coverage, full accessibility compliance, production-ready performance).

### Gate Status

Gate: PASS → docs/qa/gates/3.3-pause-system.yml

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Task 1 implementation: Pause state management system
- usePauseInput hook testing and validation
- GameStateManager pause functionality integration

### Completion Notes List
- **Task 1 COMPLETED**: Pause State Management System
  - ✅ Enhanced uiStore with `isPaused` state and pause actions
  - ✅ Created usePauseInput hook with ESC key handling and validation
  - ✅ Added pause/resume functionality to GameStateManager with state preservation
  - ✅ Implemented comprehensive test coverage (31 tests passing)
  - ✅ ESC key integration with proper event handling and cleanup

### File List
#### Created Files:
- `src/hooks/usePauseInput.ts` - ESC key handling and pause state management hook
- `src/hooks/usePauseInput.test.ts` - Comprehensive test coverage for pause input hook
- `src/hooks/useGameStateIntegration.ts` - Integration hook for game state management
- `src/hooks/useGameStateIntegration.test.ts` - Tests for game state integration
- `src/hooks/usePauseMenuNavigation.ts` - Menu navigation and keyboard handling
- `src/hooks/usePauseMenuNavigation.test.ts` - Navigation tests
- `src/components/game/PauseMenu/PauseMenu.tsx` - Main pause menu component
- `src/components/game/PauseMenu/PauseMenu.test.tsx` - Pause menu unit tests
- `src/components/game/PauseMenu/PauseMenu.mainmenu.test.tsx` - Main menu navigation tests
- `src/components/game/PauseMenu/PauseMenu.module.css` - Pause menu styles
- `src/components/game/PauseMenu/PauseOverlay.tsx` - Modal overlay component
- `src/components/game/PauseMenu/MenuButton.tsx` - Reusable menu button component
- `src/components/game/PauseMenu/MenuButton.test.tsx` - Menu button tests
- `src/components/game/PauseMenu/PauseMenuSettings.tsx` - Settings integration component
- `src/components/game/PauseMenu/PauseMenuSettings.test.tsx` - Settings tests
- `src/components/game/PauseMenu/ConfirmationDialog.tsx` - Confirmation dialog component
- `src/components/game/PauseMenu/ConfirmationDialog.module.css` - Dialog styles
- `src/components/game/PauseMenu/index.ts` - Barrel exports

#### Modified Files:
- `src/stores/uiStore.ts` - Added isPaused state, pauseGame/resumeGame/togglePause actions, useIsPaused selector
- `src/game/core/GameState.ts` - Added pause(), resume(), togglePause(), isPaused() methods with state preservation
- `src/game/core/GameState.test.ts` - Added 9 test cases for pause functionality
