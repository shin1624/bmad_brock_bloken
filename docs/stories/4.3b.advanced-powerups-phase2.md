# Story 4.3b: é«˜åº¦ãªãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—å®Ÿè£… Phase 2

**Epic**: 4. ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ   
**Status**: Approval Pending - Blocked by Prerequisites (See Blockers section)
**Story Statement**: "As a ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ I want æ™‚é–“æ“ä½œã¨æ”»æ’ƒçš„ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ— So that ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæˆ¦è¡“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå¢—ãˆã‚‹"  
**Created Date**: 2025-01-29  
**Assigned To**: Dev Agent  
**PO Review Date**: 2025-01-08  

## Story Context

Epic 4 focuses on implementing a comprehensive power-up system. Story 4.3b (Phase 2) implements the more complex advanced power-ups that require additional systems: Slow Motion and Laser Gun. This story depends on the completion of 4.3a and requires the new ProjectileSystem design.

**Prerequisites:**
- Story 4.3a must be completed first
- ProjectileSystem design document must be approved
- Performance benchmarking environment must be established

**Existing System Integration:**
- Integrates with: PowerUpSystem, PowerUpPlugin base class, PowerUpRegistry
- New system required: ProjectileSystem for laser functionality
- Technology: TypeScript, Canvas API, Plugin Architecture
- Touch points: Game loop timing, collision system expansion

## Acceptance Criteria

**Functional Requirements:**
1. **AC1**: ã‚¹ãƒ­ãƒ¼ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£… - Game time slows to 50% speed for 10 seconds (paddle remains normal speed)
2. **AC2**: ãƒ¬ãƒ¼ã‚¶ãƒ¼ç™ºå°„å®Ÿè£… - Shoot projectiles from paddle edges at 2 shots per second for 20 seconds
3. **AC3**: ProjectileSystemå®Ÿè£… - New system manages laser projectiles with object pooling

**Integration Requirements:**
4. Each power-up follows existing PowerUpPlugin pattern
5. Power-ups registered through PowerUpRegistry
6. Visual indicators integrated with HUD PowerUpStatus component  
7. All Phase 1 power-ups (Shield, Pierce, Magnet) remain fully functional
8. Existing basic power-ups continue to work unchanged

**Quality Requirements:**
9. Unit tests achieve 90% coverage for each new component
10. Integration tests for critical combinations:
    - Slow Motion + Multi-ball (high risk)
    - Laser + Multi-ball (high risk)
    - Slow Motion + Laser
    - All 5 advanced power-ups active
11. Visual feedback distinct and non-interfering
12. Performance maintains 55 FPS with any 3 power-ups active
13. Performance maintains 50 FPS with all 5 advanced power-ups active
14. Memory usage stays under 250MB during gameplay

**Interaction Rules:**
15. Power-up priority order: Shield > Slow Motion > Magnet > Laser > Pierce
16. Time-based effects (Slow Motion) affect all entities except paddle
17. Projectile system operates independently of ball physics

## Technical Notes

### ProjectileSystem Requirements

**Core Functionality:**
- Object pooling for projectiles (pool size: 20)
- Collision detection with blocks only (not balls or paddle)
- Projectile speed: 500 pixels/second
- Projectile size: 4x12 pixels
- Automatic cleanup of off-screen projectiles

**Integration Points:**
- Register with game update loop
- Share collision detection with existing system
- Render layer between balls and particles

### Power-Up Interaction Matrix (Phase 2)

| Power-Up A | Power-Up B | Interaction | Risk Level |
|------------|------------|------------|------------|
| Slow Motion | Multi-ball | All balls slow, paddle normal | HIGH |
| Slow Motion | Shield | Shield timing unaffected | LOW |
| Slow Motion | Pierce | Pierce duration in real-time | MEDIUM |
| Slow Motion | Magnet | Release timing preserved | LOW |
| Slow Motion | Laser | Fire rate in game-time | MEDIUM |
| Laser | Multi-ball | Laser independent of balls | HIGH |
| Laser | Shield | Both work independently | LOW |
| Laser | Pierce | No interaction | LOW |
| Laser | Magnet | Can fire while holding | MEDIUM |

### Implementation Details

**Slow Motion Power-Up:**
- File: `src/game/plugins/powerups/SlowMotionPowerUp.ts`
- GameState: Add `timeScale: number` (default 1.0, slow = 0.5)
- Visual: Time distortion overlay (wavy screen edge effect)
- Implementation: Modify deltaTime in game loop for all except paddle
- Duration: 10 seconds real-time
- Transition: Smooth scale change over 0.5 seconds

**Laser Gun Power-Up:**
- File: `src/game/plugins/powerups/LaserGunPowerUp.ts`
- System: `src/game/systems/ProjectileSystem.ts`
- GameState: Add `laserActive: boolean`
- Visual: Red laser beams from paddle edges
- Fire rate: 2 shots/second (500ms interval)
- Damage: Instant block destruction
- Duration: 20 seconds
- Audio cue: "pew" sound at 0.3 volume

### Performance Optimizations Required

1. **Effect Pooling:** Reuse visual effect objects
2. **Render Batching:** Group similar renders
3. **Conditional Updates:** Skip inactive systems
4. **Quality Settings:** Add low/medium/high quality options

## Definition of Done

- [ ] Slow Motion and Laser power-ups implemented
- [ ] ProjectileSystem fully functional with pooling
- [ ] Power-ups registered in PowerUpRegistry
- [ ] Visual effects implemented and optimized
- [ ] Unit tests pass with 90% coverage
- [ ] Integration tests pass for all combinations
- [ ] Performance benchmarks pass (55 FPS @ 3, 50 FPS @ 5)
- [ ] Memory usage under 250MB verified
- [ ] No regression in Phase 1 or basic power-ups
- [ ] Quality settings implemented
- [ ] Full power-up interaction matrix tested

## Risk and Compatibility Check

**Primary Risk:** Performance degradation with multiple effects
**Mitigation:** Implement quality settings and effect pooling
**Secondary Risk:** Slow Motion affecting game feel negatively
**Mitigation:** Careful tuning of time scale and smooth transitions

**Blockers:**
- [ ] ProjectileSystem design document approval
- [ ] Performance benchmark environment setup
- [ ] Story 4.3a completion

## Dev Notes

### Component Specifications
**New Files:**
- `src/game/plugins/powerups/SlowMotionPowerUp.ts`
- `src/game/plugins/powerups/LaserGunPowerUp.ts`
- `src/game/systems/ProjectileSystem.ts`
- `src/game/entities/Projectile.ts`
- `src/game/utils/ProjectilePool.ts`

**Modified Files:**
- `src/game/plugins/powerups/PowerUpRegistry.ts` - Add 2 new registrations
- `src/game/entities/PowerUp.ts` - Add SLOW_MOTION, LASER to PowerUpType enum
- `src/game/core/GameState.ts` - Add timeScale and laser state
- `src/game/core/GameLoop.ts` - Integrate time scaling
- `src/components/game/HUD/PowerUpStatus.tsx` - Add 2 new icons

### Testing Strategy
1. Unit tests for each new component
2. ProjectileSystem specific tests (pooling, cleanup)
3. Time scaling tests (correct entity behavior)
4. Integration tests for high-risk combinations
5. Performance profiling under load
6. Memory leak detection tests

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-29 | v1.0 | Story split from 4.3, Phase 2 created | SM Bob |
| 2025-01-08 | v1.1 | QA Risk & Test analysis completed | Quinn (QA) |
| 2025-01-08 | v1.2 | PO Review - Approval PENDING (Blockers) | Sarah (PO) |

---

## Dev Agent Record
*To be filled by development agent*

### Agent Model Used
*To be filled during development*

### Debug Log References
*To be filled during development*

### Completion Notes List
*To be filled during development*

### File List
*To be filled during development*

## QA Results

### Risk Profile & Test Design (2025-01-08)
**Reviewed by**: Quinn (Test Architect)  
**Status**: Draft Analysis Complete (Blocked - See Below)

#### Risk Assessment Summary

**Overall Risk Score**: 44/100 (HIGH RISK)

**Critical Risks Identified**: 2
1. **TECH-001** (Score 9): ProjectileSystem Architecture Complexity
   - **BLOCKER**: ProjectileSystem design document approval required
   - New subsystem affects game loop, collision, rendering
   - Mitigation: Design approval + prototype validation before coding

2. **PERF-001** (Score 9): Slow Motion + Multi-ball Performance
   - Multiple balls with time-scaled physics
   - Target: 55 FPS with 3 balls + Slow Motion
   - Mitigation: Early profiling, quality settings, effect pooling

**High Risks**: 3 (Score 6)
- TECH-002: Time scale implementation complexity
- PERF-002: Five simultaneous power-ups (50 FPS target)
- DATA-001: Memory leak in ProjectilePool

**Total Risks**: 7 (2 critical, 3 high, 1 medium, 1 low)

#### Test Strategy Summary

**Total Test Scenarios**: 42
- **Unit Tests**: 24 (57%) - Focus on ProjectileSystem, time scale logic
- **Integration Tests**: 13 (31%) - System interactions, performance, regression
- **E2E Tests**: 5 (12%) - User journeys, real-world validation

**Priority Distribution**:
- **P0**: 18 tests (critical functionality, performance, architecture)
- **P1**: 16 tests (feature completeness, user experience)
- **P2**: 8 tests (edge cases, additional coverage)

**Risk Coverage**:
- TECH-001 (ProjectileSystem): 11 tests
- TECH-002 (Time Scaling): 8 tests
- PERF-001 (Slow Motion Perf): 5 tests
- All identified risks have dedicated test coverage

#### Blocking Issues

â›” **CANNOT PROCEED WITH DEVELOPMENT** until:

1. âœ… **ProjectileSystem Design Document Approved**
   - Complete architecture design required
   - Interface definitions with existing systems
   - Prototype validation recommended

2. âœ… **Story 4.3a Completed**
   - Phase 1 power-ups must be functional
   - Regression test baseline required

3. âœ… **Performance Benchmark Environment**
   - Profiling infrastructure setup
   - FPS measurement tools
   - Memory monitoring

#### Key Recommendations

**Before Development**:
- Approve ProjectileSystem architecture design
- Build and validate ProjectileSystem prototype
- Setup performance profiling infrastructure

**During Development**:
- Implement quality settings from start (low/medium/high)
- Early performance benchmarking (don't wait until end)
- Continuous memory leak monitoring

**Quality Gates**:
- 55 FPS with 3 power-ups active âœ…
- 50 FPS with 5 power-ups active âœ…
- Memory usage <250MB âœ…
- No Phase 1 regressions âœ…

#### Estimated Additional Time

- Risk mitigation adds ~20% to development time
- Prototype phase: +1-2 days
- Performance optimization: Budget extra time

#### Documentation References

- **Risk Profile**: `docs/qa/assessments/4.3b-risk-20250108.md`
- **Test Design**: `docs/qa/assessments/4.3b-test-design-20250108.md`

---

**QA Gate Decision**: â›” **BLOCKED - DESIGN APPROVAL REQUIRED**

Story 4.3b is HIGH RISK and requires:
1. ProjectileSystem design document approval
2. Prototype validation
3. Story 4.3a completion

Recommend addressing blockers before proceeding with implementation planning.

---

## Product Owner Review

### PO Review Summary (2025-01-08)
**Reviewed by**: Sarah (Product Owner)  
**Decision**: â¸ï¸ **APPROVAL PENDING - BLOCKERS MUST BE RESOLVED**

#### Story Quality Assessment

âœ… **Story Structure**: Excellent
- Story statement clear and user-focused
- 17 detailed acceptance criteria
- Comprehensive technical specifications
- Clear definition of done

âœ… **QA Analysis**: Complete
- Risk profile comprehensive (44/100 HIGH RISK)
- 42 test scenarios designed
- All risks have mitigation strategies

âœ… **Prerequisites Identified**: Appropriate
- Story 4.3a completion requirement clear
- ProjectileSystem design need justified
- Performance infrastructure requirement valid

#### Blocking Prerequisites

Story 4.3b **CANNOT be approved** until the following blockers are resolved:

**BLOCKER #1: ProjectileSystem Design Document** ðŸ”´
- **Status**: Not Started
- **Required**: Complete architecture design with interface definitions
- **Owner**: Architect (@architect)
- **Estimated Time**: 1-2 days
- **Why Critical**: New subsystem affecting game loop, collision, rendering
- **Action**: Create design document â†’ Architect review â†’ Prototype validation

**BLOCKER #2: Story 4.3a Completion** ðŸŸ¡
- **Status**: Implemented but tests blocked (Vitest migration)
- **Required**: Phase 1 power-ups fully functional with passing tests
- **Owner**: Dev Team (@dev)
- **Estimated Time**: 1 day
- **Why Critical**: Phase 2 builds on Phase 1 foundation
- **Action**: Complete Vitest migration â†’ Run test suite â†’ Verify functionality

**BLOCKER #3: Performance Benchmark Environment** ðŸŸ¡
- **Status**: Not Started
- **Required**: FPS measurement and memory profiling tools
- **Owner**: Dev Team (@dev)
- **Estimated Time**: 0.5-1 day
- **Why Critical**: Cannot validate 55/50 FPS and 250MB requirements
- **Action**: Integrate Chrome DevTools â†’ Create FPS counter â†’ Setup memory profiling

#### Recommended Workflow

**Phase 1: Blocker Resolution (Start Immediately)**
```
Priority 1: ProjectileSystem Design
  â””â”€ Assign to Architect
  â””â”€ Timeline: 1-2 days
  â””â”€ Deliverable: Design doc + prototype validation

Priority 2: Story 4.3a Completion (Parallel Track)
  â””â”€ Fix Vitest migration
  â””â”€ Execute test suite
  â””â”€ Timeline: 1 day

Priority 3: Performance Infrastructure (Parallel Track)
  â””â”€ Build FPS measurement tools
  â””â”€ Setup memory profiling
  â””â”€ Timeline: 0.5-1 day
```

**Phase 2: Re-Review & Approval (After Blockers Resolved)**
```
All blockers cleared
  â†“
PO re-review
  â†“
Full approval granted
  â†“
Development can begin
```

#### Estimated Timeline

- **Blocker Resolution**: 2-3 days (with parallel work)
- **Re-review**: 0.5 day
- **Total to Approval**: ~3 days

#### Risk Assessment Alignment

PO agrees with QA assessment:
- âœ… Risk score 44/100 (HIGH RISK) is accurate
- âœ… Critical risks (TECH-001, PERF-001) justify blockers
- âœ… 42 test scenarios provide adequate coverage
- âœ… Performance targets (55/50 FPS) are appropriate

#### PO Decision Rationale

**Why PENDING vs APPROVED**:
1. ProjectileSystem is entirely new - design mistakes are expensive
2. Phase 2 depends on Phase 1 stability
3. Performance requirements cannot be validated without tools
4. Starting development without blockers resolved = wasted effort

**Why PENDING vs REJECTED**:
1. Story quality is excellent
2. Requirements are clear and testable
3. Blockers are external dependencies, not story defects
4. All blockers are resolvable within reasonable timeframe

#### Next Steps for Team

**Immediate Actions**:
1. ðŸŽ¯ **Architect**: Create ProjectileSystem design document
2. ðŸŽ¯ **Dev Team**: Complete Story 4.3a (Vitest migration)
3. ðŸŽ¯ **Dev Team**: Build performance benchmark infrastructure

**Notification**:
- PO will re-review once all 3 blockers are marked complete
- Expected approval within 1 day after blockers cleared

**Do NOT**:
- âŒ Start Story 4.3b development
- âŒ Create Story 4.3b development tasks
- âŒ Assign Story 4.3b to sprint

---

**PO Approval Status**: â¸ï¸ **PENDING - Resolve 3 Blockers First**

**Blocker Tracking**:
- [ ] BLOCKER #1: ProjectileSystem Design (ðŸ”´ Critical Path)
- [ ] BLOCKER #2: Story 4.3a Complete (ðŸŸ¡ In Progress)
- [ ] BLOCKER #3: Performance Environment (ðŸŸ¡ Not Started)

**Contact**: Sarah (PO) for questions or blocker status updates