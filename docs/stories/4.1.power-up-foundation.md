# Story 4.1: パワーアップ基盤

**Epic**: 4. パワーアップシステム  
**Status**: Approval 
**Story Statement**: "As a 開発者 I want 拡張可能なパワーアップシステム So that 新しいパワーアップを簡単に追加できる"  
**Created Date**: 2025-01-17  
**Assigned To**: Dev Agent  

## Story Context

Epic 4 focuses on implementing a comprehensive power-up system that adds strategic depth to the gameplay. Story 4.1 establishes the foundational infrastructure for power-ups using a plugin architecture that allows for easy extension and maintainability. This builds on the solid foundation established in Epic 3's UI/UX system and Epic 2's core gameplay mechanics.

## Acceptance Criteria

From Epic 4.1 requirements:
- [ ] **AC1**: パワーアップ基底クラス - Base power-up class implementation
- [ ] **AC2**: プラグイン形式での追加 - Plugin-based power-up addition system
- [ ] **AC3**: 効果の重ね掛け管理 - Effect stacking management
- [ ] **AC4**: 持続時間管理 - Duration management system
- [ ] **AC5**: ビジュアルインジケーター - Visual indicators for active power-ups

## Dev Notes

### Previous Story Insights
[Source: docs/stories/3.3.story.md Dev Agent Record]
- Successfully implemented pause system with comprehensive state management
- Established pattern for React-Canvas integration using hooks
- Demonstrated effective use of Zustand for UI state management
- Pattern of comprehensive test coverage (31 tests) for complex features

### Data Models
[Source: architecture/5-コア設計パターン.md#53-プラグインアーキテクチャ]
- **Plugin Interface**: Must implement `name`, `version`, `init()`, `destroy()` methods
- **PowerUp Entity**: Extends base Entity class with `type`, `effect`, `duration` properties
- **Effect System**: Manages active effects with stacking rules and cleanup
- **PluginManager**: Central registration and lifecycle management

### Component Specifications
[Source: architecture/4-プロジェクト構造.md]
- **File Locations**:
  - `src/game/entities/PowerUp.ts` - PowerUp entity class
  - `src/game/plugins/PluginManager.ts` - Plugin management system
  - `src/game/plugins/PowerUpPlugin.ts` - Base power-up plugin
  - `src/game/systems/PowerUpSystem.ts` - Power-up system logic
- **React Integration**: Use existing pattern from HUD components
- **Visual Indicators**: Integrate with existing `src/components/game/HUD/PowerUpStatus.tsx`

### Technical Constraints
[Source: architecture/2-技術スタック詳細.md]
- TypeScript strict mode enabled
- Must maintain 60 FPS performance target
- Follow ECS (Entity-Component-System) pattern
- Use Vitest for unit testing with >90% coverage target

### Testing Requirements
[Source: architecture/10-テスト戦略.md]
- **Unit Tests (60%)**: PowerUp entity, PluginManager, effect calculations
- **Integration Tests (30%)**: Plugin registration, effect application, UI integration
- **E2E Tests (10%)**: Visual power-up activation and expiration

## Tasks / Subtasks

### Task 1: PowerUp Entity Implementation (AC: 1)
- [ ] Create `src/game/entities/PowerUp.ts` extending Entity base class
- [ ] Implement position, velocity, and collision detection
- [ ] Add power-up type identification and metadata
- [ ] Unit tests for PowerUp entity behavior

### Task 2: Plugin Architecture Foundation (AC: 2)
- [ ] Create `src/game/plugins/PluginManager.ts` with registration system
- [ ] Implement `src/game/plugins/PowerUpPlugin.ts` base class
- [ ] Add plugin lifecycle management (init, destroy)
- [ ] Unit tests for plugin registration and management

### Task 3: Effect Management System (AC: 3, 4)
- [ ] Create `src/game/systems/PowerUpSystem.ts` for effect processing
- [ ] Implement effect stacking rules and conflicts resolution
- [ ] Add duration tracking and automatic cleanup
- [ ] Integration tests for effect combinations

### Task 4: Visual Integration (AC: 5)
- [ ] Enhance existing `src/components/game/HUD/PowerUpStatus.tsx`
- [ ] Add power-up spawn and pickup animations
- [ ] Implement effect duration countdown display
- [ ] Integration tests for UI updates

### Task 5: Testing and Documentation
- [ ] Comprehensive unit test suite (>90% coverage)
- [ ] Integration tests for React-Canvas bridge
- [ ] Performance validation (60 FPS maintenance)
- [ ] API documentation for plugin developers

## Project Structure Notes

**Alignment with Architecture**: Project structure follows established patterns with clear separation between:
- Entities (`src/game/entities/`) - Game objects
- Systems (`src/game/systems/`) - Processing logic  
- Plugins (`src/game/plugins/`) - Extensibility layer
- Components (`src/components/game/`) - React UI integration

**Required Directories**: All target directories exist in current project structure. New files will follow established naming conventions and organization patterns.

## Testing

### Unit Tests
- PowerUp entity creation, movement, and collision
- PluginManager registration and lifecycle
- Effect system stacking and duration management
- PowerUpSystem processing logic

### Integration Tests  
- Plugin registration with game engine
- React-Canvas state synchronization
- HUD updates on power-up activation
- Effect cleanup on game state changes

### Performance Tests
- Power-up processing within 16ms frame budget
- Memory leak prevention in plugin lifecycle
- Effect calculation optimization

## Change Log

| Date | Author | Change Description |
|------|--------|-------------------|
| 2025-01-17 | Agent | Initial story draft creation |

---

## Dev Agent Record

### Agent Model Used
[To be filled during implementation]

### Debug Log References
[To be filled during implementation]

### Completion Notes List
[To be filled during implementation]

### File List
#### Created Files:
[To be filled during implementation]

#### Modified Files:
[To be filled during implementation]