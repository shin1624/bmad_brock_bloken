# Story 3.2: ゲームHUD

**Epic**: 3. UI/UX システム  
**Status**: Draft  
**Story Statement**: "As a プレイヤー I want ゲーム情報を確認できる So that 状況を把握できる"  
**Created Date**: 2025-01-15  
**Assigned To**: Dev Agent  

## Story Context
Epic 3 focuses on building a comprehensive UI/UX system following the layered architecture established in Stories 1.x and 2.x. Story 3.2 implements the game HUD (Heads-Up Display) interface that overlays on the game canvas to provide real-time feedback to players during gameplay, building on the solid foundation established in Story 3.1's main menu system.

## Acceptance Criteria

From Epic 3.2 requirements:
- [ ] **AC1**: 現在スコア表示 - Real-time score display with live updates
- [ ] **AC2**: 残機数表示 - Lives counter with visual indicators
- [ ] **AC3**: レベル表示 - Current level display with progression
- [ ] **AC4**: パワーアップ状態 - Active power-up indicators and timers
- [ ] **AC5**: コンボカウンター - Combo multiplier display and streak tracking

## Technical Requirements

### Performance Standards
- HUD render time <8ms per frame (60FPS compliance)
- State update latency <16ms
- Memory footprint <2MB for HUD assets
- No impact on game canvas performance

### Accessibility Standards
- WCAG 2.1 AA compliance for HUD elements
- High contrast mode support
- Screen reader compatibility
- Color-blind friendly indicators

## Tasks/Subtasks

### Task 1: HUD Container and Layout System
**Acceptance Criteria**: AC1, AC2, AC3
- [ ] Create `HUD.tsx` component (`src/components/game/HUD/`)
- [ ] Implement responsive overlay positioning system
- [ ] Create HUD layout manager with flexible positioning
- [ ] Integrate with GameCanvas component for proper layering
- [ ] Implement CSS Grid/Flexbox layout for scalable design

### Task 2: Score Display System
**Acceptance Criteria**: AC1
- [ ] Create `ScoreDisplay.tsx` component (`src/components/game/HUD/`)
- [ ] Implement real-time score updates via GameStateManager
- [ ] Create score formatting with locale support (commas, etc.)
- [ ] Add score change animations (increment effects)
- [ ] Integrate with existing scoring system from Story 2.3

### Task 3: Lives and Health Indicators
**Acceptance Criteria**: AC2
- [ ] Create `LivesDisplay.tsx` component (`src/components/game/HUD/`)
- [ ] Implement visual life indicators (hearts, icons, etc.)
- [ ] Create life loss animations and feedback
- [ ] Add health state management with visual warnings
- [ ] Integrate with game over conditions

### Task 4: Level Progression Display
**Acceptance Criteria**: AC3
- [ ] Create `LevelDisplay.tsx` component (`src/components/game/HUD/`)
- [ ] Implement level information display (current level, progress)
- [ ] Create level completion progress indicators
- [ ] Add level transition animations
- [ ] Integrate with level progression system

### Task 5: Power-Up Status System
**Acceptance Criteria**: AC4
- [ ] Create `PowerUpStatus.tsx` component (`src/components/game/HUD/`)
- [ ] Implement active power-up visualization
- [ ] Create countdown timers for power-ups
- [ ] Add power-up activation/deactivation animations
- [ ] Design icon system for different power-up types

### Task 6: Combo Counter System
**Acceptance Criteria**: AC5
- [ ] Create `ComboDisplay.tsx` component (`src/components/game/HUD/`)
- [ ] Implement combo streak tracking and display
- [ ] Create combo multiplier visualization
- [ ] Add combo break/reset animations
- [ ] Integrate with scoring system for multiplier effects

### Task 7: HUD State Management Integration
**Acceptance Criteria**: All ACs
- [ ] Create `useHUD` custom hook (`src/hooks/useHUD.ts`)
- [ ] Integrate with GameStateManager for real-time updates
- [ ] Implement event-driven state synchronization
- [ ] Create HUD state persistence for pause/resume scenarios
- [ ] Add state validation and error handling

### Task 8: Testing and Performance Optimization
**Acceptance Criteria**: All ACs, Quality Standards
- [ ] HUD component unit tests (render, state updates, animations)
- [ ] Integration tests with GameStateManager
- [ ] Performance tests for 60FPS compliance
- [ ] Accessibility compliance tests (axe-core integration)
- [ ] Cross-device responsive design validation
- [ ] Achieve >90% test coverage

## Dev Notes

### Previous Story Insights
[Source: Story 3.1 Implementation Records]

**成功パターン:**
- **Zustand Integration**: UI状態管理パターンが確立済み - HUD状態管理に直接適用可能
- **Custom Hooks Pattern**: useMainMenuパターン実証済み - useHUDで同様適用
- **React-Canvas Bridge**: ゲーム状態統合パターン確立 - HUDリアルタイム更新に活用
- **Component Architecture**: レイヤード構成実装済み - HUD Overlay層に直接統合
- **Performance Optimization**: 60FPS維持パターン確立 - HUDアニメーション実装時に適用

**技術的課題と解決済み項目:**
- **Real-time Updates**: GameStateManager統合パターン確立 - HUD状態同期に適用
- **Animation Performance**: GPU最適化アニメーション実装済み - HUDエフェクトに適用
- **Responsive Design**: CSS Grid/Flexboxパターン確立 - HUDレイアウトに適用
- **Accessibility**: WCAG準拠パターン実装済み - HUD要素に適用

### Technical Architecture Context

#### React Component Structure
[Source: docs/architecture/4-プロジェクト構造.md]
```
src/components/game/HUD/
├── HUD.tsx                    # HUDコンテナ
├── ScoreDisplay.tsx           # スコア表示
├── LivesDisplay.tsx           # 残機表示
├── LevelDisplay.tsx           # レベル表示
├── PowerUpStatus.tsx          # パワーアップ状態
├── ComboDisplay.tsx           # コンボカウンター
├── HUD.css                    # HUDスタイル
└── index.ts                   # バレルエクスポート
```

#### State Management Integration
[Source: docs/architecture/6-データフローアーキテクチャ.md]
```typescript
// HUD状態管理拡張（既存GameStateManager基盤）
interface HUDState {
  score: number;
  lives: number;
  level: number;
  powerUps: PowerUp[];
  combo: {
    count: number;
    multiplier: number;
    streak: number;
  };
  
  // 表示状態
  isVisible: boolean;
  isAnimating: boolean;
  notifications: Notification[];
}

// GameStateManager統合
class GameStateManager {
  private hudSubscribers: Set<HUDSubscriber> = new Set();
  
  subscribeHUD(subscriber: HUDSubscriber): void {
    this.hudSubscribers.add(subscriber);
  }
  
  private notifyHUD(hudData: HUDState): void {
    this.hudSubscribers.forEach(sub => sub(hudData));
  }
}
```

#### Custom Hook Pattern
[Source: docs/architecture/8-react-canvas統合.md + Story 3.1成功パターン]
```typescript
// useHUD Hook設計
function useHUD() {
  const [hudState, setHudState] = useState<HUDState>();
  const { gameState } = useGameStore();
  
  useEffect(() => {
    // GameStateManager統合（Story 3.1確立パターン）
    const unsubscribe = gameStateManager.subscribeHUD((newHudState) => {
      setHudState(newHudState);
    });
    
    return unsubscribe;
  }, []);
  
  const updateScore = useCallback((points: number) => {
    gameStateManager.updateScore(points);
  }, []);
  
  return { hudState, updateScore, /* ... */ };
}
```

#### Animation System Design
[Source: CSS Modules + GPU最適化パターン from Story 3.1]
```css
/* HUD.module.css */
.hudOverlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 10;
}

.scoreIncrease {
  animation: scoreIncrement 0.3s ease-out;
  transform: scale(1.1);
}

.comboMultiplier {
  animation: comboGlow 0.5s ease-in-out infinite alternate;
  text-shadow: 0 0 10px currentColor;
}

.powerUpTimer {
  background: linear-gradient(90deg, #ff6b6b 0%, #ffa500 var(--progress));
  transition: width 0.1s linear;
}
```

### Performance Considerations
[Source: docs/architecture/11-パフォーマンス最適化.md]

- **Component Memoization**: React.memo でHUDコンポーネント最適化
- **State Update Optimization**: useCallbackでイベントハンドラー最適化
- **Animation Performance**: CSS transformsでGPUアクセラレーション活用
- **Bundle Size**: HUD関連アセットの最適化（<500KB target）

### Testing Strategy
[Source: docs/architecture/10-テスト戦略.md + Story 3.1成功実績]

**Unit Tests (60%)**:
```typescript
// HUD.test.tsx
describe('HUD Component', () => {
  it('should display current score', () => {
    const mockHudState = { score: 1500, lives: 3, level: 2 };
    render(<HUD hudState={mockHudState} />);
    expect(screen.getByText('1,500')).toBeInTheDocument();
  });
  
  it('should update score in real-time', async () => {
    const { updateScore } = renderHook(() => useHUD());
    await act(() => updateScore(100));
    expect(gameStateManager.updateScore).toHaveBeenCalledWith(100);
  });
});
```

**Integration Tests (30%)**:
- HUD-GameStateManager同期テスト
- リアルタイム状態更新テスト
- パフォーマンステスト（60FPS維持）

**E2E Tests (10%)**:
- 完全ゲームプレイフロー（HUD表示、スコア更新、ゲームオーバー）

### Data Models and Type Definitions
[Source: 既存 src/types/game.types.ts 拡張]

```typescript
// HUDシステム型定義
interface HUDData {
  score: number;
  lives: number;
  level: number;
  powerUps: ActivePowerUp[];
  combo: ComboState;
  notifications: HUDNotification[];
}

interface ActivePowerUp {
  id: string;
  type: PowerUpType;
  duration: number;         // 残り時間（ミリ秒）
  icon: string;
  color: string;
}

interface ComboState {
  count: number;            // 現在のコンボ数
  multiplier: number;       // スコア倍率
  streak: number;           // 連続ヒット数
  timeRemaining: number;    // コンボ終了までの時間
}

interface HUDNotification {
  id: string;
  type: 'score' | 'powerup' | 'combo' | 'life';
  message: string;
  duration: number;
  priority: number;
}

enum PowerUpType {
  MultiBall = 'multiball',
  PaddleSize = 'paddlesize',
  BallSpeed = 'ballspeed',
  Penetration = 'penetration',
  Magnet = 'magnet'
}
```

### Asset Requirements
[Source: docs/architecture/4-プロジェクト構造.md assets管理]

```
src/assets/hud/
├── icons/
│   ├── heart.svg              # ライフアイコン
│   ├── star.svg               # スコアアイコン
│   ├── level.svg              # レベルアイコン
│   └── powerups/              # パワーアップアイコン
├── backgrounds/
│   └── hud-overlay.png        # HUD背景オーバーレイ
└── animations/
    ├── score-increment.css    # スコア増加アニメーション
    └── combo-glow.css         # コンボエフェクト
```

## Testing

### Testing Standards
[Source: docs/architecture/10-テスト戦略.md]

**Test File Location**: `src/components/game/HUD/__tests__/`
**Testing Framework**: Vitest + React Testing Library
**Coverage Target**: >90% for HUD components
**Performance Testing**: 60FPS compliance validation

**Specific Testing Requirements**:
- Real-time state update testing with GameStateManager
- Animation performance testing
- Accessibility compliance testing (axe-core)
- Cross-device responsive testing
- HUD overlay z-index and positioning testing

## Definition of Done

### Functional Requirements
- [ ] All AC requirements implemented and validated
- [ ] HUD displays real-time game information
- [ ] Score updates synchronize with game state
- [ ] Lives display shows current player status
- [ ] Level information displays accurately
- [ ] Power-up status shows active effects and timers
- [ ] Combo counter tracks and displays streaks

### Technical Requirements
- [ ] TypeScript strict mode compliance
- [ ] Component test coverage >90%
- [ ] Performance benchmarks met (<8ms HUD render time)
- [ ] Accessibility WCAG 2.1 AA compliance validated
- [ ] Cross-device responsive design tested
- [ ] No impact on game canvas performance (60FPS maintained)

### Quality Gates
- [ ] Code review completed with architecture team
- [ ] Integration tests passing with GameStateManager
- [ ] Performance regression tests passing
- [ ] Accessibility audit completed with axe-core
- [ ] User acceptance testing completed

## Integration Dependencies

### From Previous Stories
- **Story 3.1**: React UI パターン確立 - HUDコンポーネント構造に活用
- **Story 2.3**: ScoreManager統合 - リアルタイムスコア表示に連携
- **Story 2.4**: GameStateManager統合 - HUD状態同期に連携
- **Story 1.3**: EventBus統合 - HUD状態更新イベント配信に活用

### For Future Stories
- **Story 3.3**: 一時停止システム統合 - HUD表示制御拡張
- **Story 4.1**: パワーアップシステム統合 - パワーアップ表示拡張
- **Story 5.1**: テーマシステム統合 - HUDテーマ適用

---

**Ready for Development**: この story は完全に準備済みで、開発エージェントによる実装準備ができています。すべての技術的依存関係、アーキテクチャ詳細、および実装ガイダンスが提供されています。

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-15 | 1.0 | Initial story creation | BMad Master |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

## QA Results

*This section will be populated by the QA agent during review*