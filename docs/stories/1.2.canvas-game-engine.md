# Story 1.2: Canvasゲームエンジン基盤（段階的実装）

## Status
Complete

## Story
**As a** 開発者,  
**I want** requestAnimationFrameベースのゲームループとReact統合システム,  
**so that** 60FPSでの安定したゲーム描画とパフォーマンス監視ができる

## Acceptance Criteria

### Phase 1-A: ゲームループ
1. requestAnimationFrameベースのゲームループ実装
2. 60 FPS での安定動作とパフォーマンスモニタリング
3. useGameLoopカスタムフックによるReact統合
4. FPSカウンターとデバッグ情報表示
5. 既存Reactアプリケーション機能の保持

### Phase 1-B: Canvas統合
6. Canvas要素のReactコンポーネント化
7. 基本的な描画メソッド実装
8. React-Canvas状態同期システム
9. GameCanvasコンポーネントの作成
10. 描画パイプラインの基礎実装

## Tasks / Subtasks

- [x] **Task 1: ゲームループコア実装** (AC: 1, 2)
  - [x] GameLoop クラス作成 (`src/game/core/GameLoop.ts`)
  - [x] requestAnimationFrame ベースのループ実装
  - [x] deltaTime 計算とフレーム制御
  - [x] パフォーマンス監視機能追加
  - [x] ループの開始/停止/一時停止メソッド

- [x] **Task 2: useGameLoop カスタムフック実装** (AC: 3)
  - [x] フック作成 (`src/hooks/useGameLoop.ts`)
  - [x] GameLoop インスタンス管理
  - [x] React ライフサイクル統合
  - [x] パフォーマンスメトリクス取得

- [x] **Task 3: FPS カウンター・デバッグUI** (AC: 4)
  - [x] FPS 計算ロジック実装
  - [x] デバッグ情報収集システム
  - [x] デバッグUI コンポーネント作成
  - [x] 開発環境でのみ表示する条件分岐

- [x] **Task 4: GameCanvas コンポーネント実装** (AC: 6, 9)
  - [x] GameCanvas コンポーネント作成 (`src/components/game/GameCanvas.tsx`)
  - [x] Canvas要素のref管理
  - [x] Canvas context 初期化
  - [x] リサイズ対応とビューポート管理

- [x] **Task 5: React-Canvas 状態ブリッジ** (AC: 8)
  - [x] ゲーム状態とReact状態の同期機能
  - [x] イベントシステム統合
  - [x] 双方向データフロー実装

- [x] **Task 6: 基本描画システム** (AC: 7, 10)
  - [x] 基本描画メソッド実装
  - [x] 描画パイプライン基礎構築
  - [x] エンティティレンダリング準備

- [x] **Task 7: ユニットテスト** (AC: 全般)
  - [x] GameLoop テスト作成
  - [x] useGameLoop テスト作成
  - [x] GameCanvas コンポーネントテスト
  - [x] テストカバレッジ >90% 達成

## Dev Notes

### Previous Story Insights
- Story 1.1 でプロジェクトセットアップが完了済み
- React 19 + TypeScript 5 + Vite 環境構築済み
- Zustand状態管理、ESLint、Prettier、Tailwind CSS 設定完了

### Technical Architecture Context

#### Core Technology Stack
[Source: architecture/2-技術スタック詳細.md#21-コア技術]
- **Frontend**: React 18.3 + TypeScript 5.4 + Vite 5.x
- **Rendering**: Canvas 2D API (primary), WebGL (future option)
- **State Management**: Zustand 4.x (UI), Custom GameStateManager (game)
- **Testing**: Vitest 1.x (unit), React Testing Library (component)

#### Project Structure Guidelines
[Source: architecture/4-プロジェクト構造.md]
- **Game Engine**: `src/game/core/` (GameEngine.ts, GameLoop.ts, GameState.ts, EventBus.ts)
- **Hooks**: `src/hooks/` (useGameEngine.ts, useKeyboard.ts, useTouch.ts, useResponsive.ts)
- **Game Components**: `src/components/game/` (GameContainer/, HUD/, PauseMenu/)
- **Types**: `src/types/` (game.types.ts, ui.types.ts)

#### React-Canvas Integration Patterns
[Source: architecture/8-react-canvas統合.md]
- **Bridge Pattern**: GameCanvas component with useRef for canvas element
- **Engine Initialization**: GameEngine instantiation in useEffect
- **State Synchronization**: Bidirectional binding with onStateChange events
- **Custom Hooks**: useGameEngine for engine lifecycle management
- **Input Handling**: Event listeners for keyboard/mouse/touch inputs

#### Coding Standards
[Source: architecture/9-コーディング標準.md]
- **Naming**: PascalCase for classes, camelCase for functions/methods
- **File Structure**: 1 file = 1 export, barrel exports in index.ts
- **TypeScript**: Explicit type definitions, avoid `any` type usage
- **Private Members**: No underscore prefix needed

### Testing Standards
[Source: architecture/10-テスト戦略.md]
- **Test Pyramid**: 60% unit tests (Vitest), 30% integration (React Testing Library), 10% E2E (Playwright)
- **Unit Test Focus**: GameLoop timing logic, state management, utility functions
- **Component Testing**: React Testing Library for GameCanvas and related UI
- **Test Coverage**: >90% for game logic components
- **Test Files**: Co-located with source files using `.test.ts` suffix

### Performance Targets
[Source: prd/4-エピックとユーザーストーリー.md#技術仕様]
- **FPS Target**: 60 FPS維持率 >95%
- **Input Latency**: <16ms response time
- **Memory Management**: Efficient object pooling for frequent allocations

### Integration Points
- **Existing React App**: Must maintain compatibility with existing components
- **Zustand Store**: UI state continues through existing patterns
- **Development Tools**: React DevTools + Chrome DevTools integration

## QA Results

### Review Date: 2025-09-12

### Reviewed By: Quinn (Test Architect)

**Implementation Assessment:**
- ✅ All 10 acceptance criteria fully implemented
- ✅ Comprehensive component architecture with proper separation of concerns  
- ✅ High-performance requestAnimationFrame-based game loop
- ✅ React integration through well-designed custom hooks
- ✅ Debug tooling with development environment detection
- ✅ Robust rendering system with entity management and culling
- ✅ Extensive test suite covering core components

**Quality Observations:**
- Strong architectural foundation for game engine
- Proper TypeScript implementation with interface contracts
- Good performance monitoring and debugging capabilities
- Test coverage includes unit tests for all major components

**Minor Issues Identified:**
- Some test instability in async mock scenarios (non-blocking)
- TypeScript configuration warning (cosmetic, no functional impact)

### Gate Status

Gate: PASS → docs/qa/gates/1.2-canvas-game-engine.yml

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-11 | 1.0 | Initial story draft creation | Bob (Scrum Master) |
| 2025-09-12 | 1.1 | QA review completed | Quinn (Test Architect) |