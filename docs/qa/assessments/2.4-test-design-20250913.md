# Test Design: Story 2.4

Date: 2025-09-13
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 27
- Unit tests: 15 (56%)
- Integration tests: 8 (30%) 
- E2E tests: 4 (14%)
- Priority distribution: P0: 12, P1: 9, P2: 6

## Test Scenarios by Acceptance Criteria

### AC1: AABB（Axis-Aligned Bounding Box）衝突検出実装

#### Scenarios

| ID            | Level       | Priority | Test                              | Justification                    | Risk Coverage |
| ------------- | ----------- | -------- | --------------------------------- | -------------------------------- | ------------- |
| 2.4-UNIT-001  | Unit        | P0       | AABB重複判定アルゴリズム          | 純粋な数学ロジック               | TECH-001      |
| 2.4-UNIT-002  | Unit        | P0       | 境界条件テスト（エッジ、角）      | エッジケース処理                 | TECH-001      |
| 2.4-UNIT-003  | Unit        | P1       | AABB計算精度（浮動小数点）        | 数値計算の安定性                 | TECH-001      |
| 2.4-INT-001   | Integration | P0       | CollisionDetector AABB拡張        | 既存システム統合                 | TECH-001      |
| 2.4-INT-002   | Integration | P1       | EventBus衝突イベント配信          | イベント駆動アーキテクチャ       | -             |
| 2.4-E2E-001   | E2E         | P1       | 実ゲームプレイ衝突精度検証        | エンドユーザー体験               | PERF-005      |

### AC2: ボール-パドル衝突（反射角計算含む）

#### Scenarios

| ID            | Level       | Priority | Test                              | Justification                    | Risk Coverage |
| ------------- | ----------- | -------- | --------------------------------- | -------------------------------- | ------------- |
| 2.4-UNIT-004  | Unit        | P0       | 反射角計算数学ロジック            | 純粋な物理計算                   | -             |
| 2.4-UNIT-005  | Unit        | P0       | 打点位置による角度変化            | ゲームプレイコア機能             | -             |
| 2.4-UNIT-006  | Unit        | P1       | 速度ベクトル変換精度              | 物理演算の正確性                 | PERF-005      |
| 2.4-INT-003   | Integration | P0       | Ball-Paddle物理相互作用           | 複数コンポーネント連携           | -             |
| 2.4-E2E-002   | E2E         | P1       | プレイヤー操作反射挙動            | ユーザーエクスペリエンス         | -             |

### AC3: ボール-ブロック衝突（ブロック破壊処理含む）

#### Scenarios

| ID            | Level       | Priority | Test                              | Justification                    | Risk Coverage |
| ------------- | ----------- | -------- | --------------------------------- | -------------------------------- | ------------- |
| 2.4-UNIT-007  | Unit        | P0       | ブロック破壊判定ロジック          | ビジネスルール検証               | -             |
| 2.4-UNIT-008  | Unit        | P0       | 衝突応答計算（位置補正）          | 物理演算精度                     | TECH-001      |
| 2.4-INT-004   | Integration | P0       | ブロック状態更新統合              | システム状態整合性               | -             |
| 2.4-INT-005   | Integration | P0       | スコア加算EventBus統合            | ゲームロジック連携               | -             |
| 2.4-E2E-003   | E2E         | P0       | ブロック破壊ゲームプレイ          | クリティカルユーザージャーニー   | -             |

### AC4: 複数同時衝突の優先順位処理

#### Scenarios

| ID            | Level       | Priority | Test                              | Justification                    | Risk Coverage |
| ------------- | ----------- | -------- | --------------------------------- | -------------------------------- | ------------- |
| 2.4-UNIT-009  | Unit        | P0       | 優先順位アルゴリズム              | 複雑ロジック単体検証             | TECH-004      |
| 2.4-UNIT-010  | Unit        | P0       | 競合解決ロジック                  | エッジケース処理                 | TECH-004      |
| 2.4-UNIT-011  | Unit        | P1       | 最短距離優先アルゴリズム          | 最適化ロジック                   | TECH-004      |
| 2.4-INT-006   | Integration | P0       | CollisionPriorityManager統合      | システム統合動作                 | TECH-004      |
| 2.4-INT-007   | Integration | P1       | 優先順位EventBus統合              | イベント配信順序                 | TECH-004      |

### AC5: 貫通バグの防止（フレーム間移動距離考慮）

#### Scenarios

| ID            | Level       | Priority | Test                              | Justification                    | Risk Coverage |
| ------------- | ----------- | -------- | --------------------------------- | -------------------------------- | ------------- |
| 2.4-UNIT-012  | Unit        | P0       | 軌跡計算アルゴリズム              | 数学的正確性                     | PERF-002      |
| 2.4-UNIT-013  | Unit        | P0       | 時間衝突検出（ToI）               | CCD コアロジック                 | PERF-002      |
| 2.4-UNIT-014  | Unit        | P1       | タイムステップ細分化              | 精度向上アルゴリズム             | PERF-002      |
| 2.4-UNIT-015  | Unit        | P2       | CCD性能最適化ロジック             | パフォーマンス要件               | PERF-002      |
| 2.4-INT-008   | Integration | P0       | ContinuousCollisionDetector統合   | 高度システム統合                 | PERF-002      |
| 2.4-E2E-004   | E2E         | P0       | 高速ボール貫通防止                | クリティカル品質要件             | PERF-002      |

## Performance Testing (追加)

#### Scenarios

| ID            | Level       | Priority | Test                              | Justification                    | Risk Coverage |
| ------------- | ----------- | -------- | --------------------------------- | -------------------------------- | ------------- |
| 2.4-PERF-001  | Integration | P0       | CCD処理時間5ms制限検証            | 性能要件準拠                     | PERF-002      |
| 2.4-PERF-002  | Integration | P0       | SpatialHashメモリ使用量50MB制限   | リソース制約検証                 | PERF-003      |
| 2.4-PERF-003  | Integration | P1       | 200同時衝突処理負荷テスト         | スケーラビリティ                 | PERF-005      |

## Risk Coverage

All identified high-risk areas have dedicated test coverage:

- **TECH-001** (AABB複雑性): 6 scenarios covering boundary conditions and precision
- **PERF-002** (CCD処理負荷): 5 scenarios including performance constraints  
- **PERF-005** (精度vs性能): 4 scenarios validating quality under constraints
- **TECH-004** (優先順位競合): 5 scenarios for conflict resolution
- **PERF-003** (メモリ使用量): 1 dedicated performance test

## Recommended Execution Order

### Phase 1: Critical Foundation (P0 Unit Tests)
1. AABB算法検証 (2.4-UNIT-001, 002) 
2. 反射角計算 (2.4-UNIT-004, 005)
3. ブロック破壊判定 (2.4-UNIT-007, 008)
4. 優先順位アルゴリズム (2.4-UNIT-009, 010)
5. CCD軌跡計算 (2.4-UNIT-012, 013)

### Phase 2: Integration Validation (P0 Integration Tests)
1. CollisionDetector拡張 (2.4-INT-001)
2. Ball-Paddle統合 (2.4-INT-003)
3. ブロック状態・スコア統合 (2.4-INT-004, 005)
4. 優先順位マネージャー (2.4-INT-006)
5. CCD統合 (2.4-INT-008)

### Phase 3: Critical Path Validation (P0 E2E + Performance)
1. 高速ボール貫通防止 (2.4-E2E-004)
2. ブロック破壊ゲームプレイ (2.4-E2E-003)
3. CCD処理時間制限 (2.4-PERF-001)
4. メモリ使用量制限 (2.4-PERF-002)

### Phase 4: Secondary Features (P1 Tests)
All remaining P1 scenarios

### Phase 5: Enhancement Testing (P2 Tests)
P2 scenarios as time permits

## Test Data Requirements

- **ボール速度バリエーション**: 低速(100px/s), 中速(500px/s), 高速(1000px/s)
- **衝突角度**: 直角、鋭角、鈍角の組み合わせ
- **ブロック配置**: 密集、疎、混合パターン
- **同時衝突**: 2-5オブジェクト同時衝突シナリオ
- **エッジケース**: 境界ピクセル、浮動小数点精度限界

## Success Criteria

- **Unit Tests**: 100% pass rate required
- **Integration Tests**: 95% pass rate minimum  
- **E2E Tests**: 90% pass rate minimum
- **Performance Tests**: All timing/memory constraints met
- **Coverage**: >90% code coverage for collision detection modules