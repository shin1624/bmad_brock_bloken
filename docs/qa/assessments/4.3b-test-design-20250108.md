# Test Design: Story 4.3b - Advanced Power-ups Phase 2

**Date**: 2025-01-08  
**Designer**: Quinn (Test Architect)  
**Story**: 4.3b - 高度なパワーアップ実装 Phase 2  
**Status**: Draft (Blocked by ProjectileSystem design)

## Test Strategy Overview

- **Total Test Scenarios**: 42
- **Unit Tests**: 24 (57%)
- **Integration Tests**: 13 (31%)
- **E2E Tests**: 5 (12%)
- **Priority Distribution**: P0: 18, P1: 16, P2: 8

**Risk-Driven Focus**: High test coverage for TECH-001 (ProjectileSystem) and PERF-001 (Slow Motion + Multi-ball)

---

## Test Scenarios by Acceptance Criteria

### AC1: Slow Motion Power-up Implementation

**Requirement**: Game time slows to 50% speed for 10 seconds (paddle remains normal speed)

| Test ID       | Level       | Priority | Test Scenario                                | Justification                     | Risk Mitigation |
|---------------|-------------|----------|----------------------------------------------|-----------------------------------|-----------------|
| 4.3b-UNIT-001 | Unit        | P0       | Time scale calculation (1.0 → 0.5)          | Pure logic, critical for feature | TECH-002        |
| 4.3b-UNIT-002 | Unit        | P0       | Transition smoothness (0.5s ramp)            | Algorithm validation              | TECH-002        |
| 4.3b-UNIT-003 | Unit        | P0       | Duration tracking (10s real-time)            | Timer logic correctness           | TECH-002        |
| 4.3b-UNIT-004 | Unit        | P1       | Paddle velocity exception (normal speed)     | Critical exception logic          | TECH-002        |
| 4.3b-INT-001  | Integration | P0       | Ball velocity scaled to 50% during effect    | Physics system integration        | TECH-002        |
| 4.3b-INT-002  | Integration | P0       | Paddle moves at 100% speed during effect     | Exception handling validation     | TECH-002        |
| 4.3b-INT-003  | Integration | P0       | Multiple balls all slow simultaneously       | Multi-entity time scaling         | PERF-001        |
| 4.3b-INT-004  | Integration | P1       | Effect expiration restores normal time       | State cleanup                     | TECH-002        |
| 4.3b-E2E-001  | E2E         | P1       | Player activates Slow Motion power-up        | User journey validation           | -               |

**Coverage**: 9 tests (4 unit, 4 integration, 1 e2e)

---

### AC2: Laser Gun Power-up Implementation

**Requirement**: Shoot projectiles from paddle edges at 2 shots per second for 20 seconds

| Test ID       | Level       | Priority | Test Scenario                                | Justification                     | Risk Mitigation |
|---------------|-------------|----------|----------------------------------------------|-----------------------------------|-----------------|
| 4.3b-UNIT-005 | Unit        | P0       | Fire rate calculation (500ms interval)       | Pure timing logic                 | TECH-003        |
| 4.3b-UNIT-006 | Unit        | P0       | Projectile spawn position (paddle edges)     | Positioning algorithm             | TECH-003        |
| 4.3b-UNIT-007 | Unit        | P0       | Duration tracking (20s)                      | Timer logic                       | TECH-003        |
| 4.3b-UNIT-008 | Unit        | P1       | Projectile initial velocity (500 px/s)       | Physics calculation               | TECH-003        |
| 4.3b-INT-005  | Integration | P0       | Laser fires while paddle moves               | System coordination               | TECH-003        |
| 4.3b-INT-006  | Integration | P0       | Projectiles destroy blocks on contact        | Collision integration             | TECH-003        |
| 4.3b-INT-007  | Integration | P1       | Sound effect plays on laser fire (0.3 vol)   | Audio system integration          | -               |
| 4.3b-INT-008  | Integration | P1       | Off-screen projectiles cleaned up            | Memory management                 | DATA-001        |
| 4.3b-E2E-002  | E2E         | P1       | Player activates Laser power-up              | User journey validation           | -               |

**Coverage**: 9 tests (4 unit, 4 integration, 1 e2e)

---

### AC3: ProjectileSystem Implementation

**Requirement**: New system manages laser projectiles with object pooling

| Test ID       | Level       | Priority | Test Scenario                                | Justification                     | Risk Mitigation |
|---------------|-------------|----------|----------------------------------------------|-----------------------------------|-----------------|
| 4.3b-UNIT-009 | Unit        | P0       | ProjectilePool initializes with 20 objects   | Pool setup validation             | TECH-001        |
| 4.3b-UNIT-010 | Unit        | P0       | Acquire projectile from pool                 | Pool management logic             | TECH-001        |
| 4.3b-UNIT-011 | Unit        | P0       | Release projectile to pool                   | Pool management logic             | TECH-001        |
| 4.3b-UNIT-012 | Unit        | P0       | Pool returns null when exhausted             | Edge case handling                | TECH-001        |
| 4.3b-UNIT-013 | Unit        | P1       | Projectile update calculates position        | Movement algorithm                | TECH-001        |
| 4.3b-UNIT-014 | Unit        | P1       | Projectile marked for cleanup when off-screen| Cleanup logic                     | DATA-001        |
| 4.3b-INT-009  | Integration | P0       | ProjectileSystem registers with game loop    | System integration                | TECH-001        |
| 4.3b-INT-010  | Integration | P0       | Projectile collision detected with blocks    | Collision system integration      | TECH-001        |
| 4.3b-INT-011  | Integration | P0       | Projectile rendering between balls/particles | Render layer ordering             | TECH-001        |
| 4.3b-INT-012  | Integration | P1       | Pool handles 20 simultaneous projectiles     | Load testing                      | DATA-001        |
| 4.3b-INT-013  | Integration | P1       | Memory usage stable during projectile cycling| Memory leak detection             | DATA-001        |

**Coverage**: 11 tests (6 unit, 5 integration, 0 e2e)

---

### AC4-8: Integration Requirements

**Requirements**: Plugin pattern, registry, HUD, no regression

| Test ID       | Level       | Priority | Test Scenario                                | Justification                     | Risk Mitigation |
|---------------|-------------|----------|----------------------------------------------|-----------------------------------|-----------------|
| 4.3b-UNIT-015 | Unit        | P0       | SlowMotionPowerUp extends PowerUpPlugin      | Architecture compliance           | -               |
| 4.3b-UNIT-016 | Unit        | P0       | LaserGunPowerUp extends PowerUpPlugin        | Architecture compliance           | -               |
| 4.3b-INT-014  | Integration | P0       | Both power-ups registered in PowerUpRegistry | Registry integration              | -               |
| 4.3b-INT-015  | Integration | P1       | HUD displays Slow Motion icon                | UI integration                    | -               |
| 4.3b-INT-016  | Integration | P1       | HUD displays Laser Gun icon                  | UI integration                    | -               |
| 4.3b-INT-017  | Integration | P0       | Phase 1 power-ups still functional (Shield)  | Regression prevention             | OPS-001         |
| 4.3b-INT-018  | Integration | P0       | Phase 1 power-ups still functional (Pierce)  | Regression prevention             | OPS-001         |
| 4.3b-INT-019  | Integration | P0       | Phase 1 power-ups still functional (Magnet)  | Regression prevention             | OPS-001         |

**Coverage**: 8 tests (2 unit, 6 integration, 0 e2e)

---

### AC9: Unit Test Coverage

**Requirement**: 90% coverage for each new component

| Test ID       | Level       | Priority | Test Scenario                                | Justification                     | Risk Mitigation |
|---------------|-------------|----------|----------------------------------------------|-----------------------------------|-----------------|
| 4.3b-UNIT-017 | Unit        | P1       | SlowMotionPowerUp activate method            | Method coverage                   | -               |
| 4.3b-UNIT-018 | Unit        | P1       | SlowMotionPowerUp deactivate method          | Method coverage                   | -               |
| 4.3b-UNIT-019 | Unit        | P1       | LaserGunPowerUp activate method              | Method coverage                   | -               |
| 4.3b-UNIT-020 | Unit        | P1       | LaserGunPowerUp deactivate method            | Method coverage                   | -               |
| 4.3b-UNIT-021 | Unit        | P1       | ProjectileSystem update method               | Method coverage                   | -               |
| 4.3b-UNIT-022 | Unit        | P1       | ProjectileSystem render method               | Method coverage                   | -               |

**Coverage**: 6 tests (all unit)

---

### AC10: Integration Tests for Critical Combinations

**Requirement**: Test high-risk power-up combinations

| Test ID       | Level       | Priority | Test Scenario                                | Justification                     | Risk Mitigation |
|---------------|-------------|----------|----------------------------------------------|-----------------------------------|-----------------|
| 4.3b-INT-020  | Integration | P0       | Slow Motion + Multi-ball (3 balls)           | High-risk combination             | PERF-001        |
| 4.3b-INT-021  | Integration | P0       | Laser + Multi-ball (3 balls)                 | High-risk combination             | TECH-003        |
| 4.3b-INT-022  | Integration | P0       | Slow Motion + Laser                          | Interaction validation            | PERF-002        |
| 4.3b-INT-023  | Integration | P1       | All 5 advanced power-ups active              | Maximum load scenario             | PERF-002        |
| 4.3b-E2E-003  | E2E         | P1       | Player uses Slow Motion in gameplay          | User experience validation        | TECH-002        |
| 4.3b-E2E-004  | E2E         | P1       | Player uses Laser in gameplay                | User experience validation        | TECH-003        |

**Coverage**: 6 tests (4 integration, 2 e2e)

---

### AC11-14: Performance and Memory Requirements

**Requirements**: FPS targets and memory limits

| Test ID       | Level       | Priority | Test Scenario                                | Justification                     | Risk Mitigation |
|---------------|-------------|----------|----------------------------------------------|-----------------------------------|-----------------|
| 4.3b-PERF-001 | Integration | P0       | 55 FPS with 3 power-ups active               | Performance benchmark             | PERF-002        |
| 4.3b-PERF-002 | Integration | P0       | 50 FPS with 5 power-ups active               | Performance benchmark             | PERF-002        |
| 4.3b-PERF-003 | Integration | P0       | 55 FPS with Slow Motion + 3 balls            | Critical performance case         | PERF-001        |
| 4.3b-PERF-004 | Integration | P0       | Memory <250MB during gameplay                | Memory limit validation           | DATA-001        |
| 4.3b-PERF-005 | Integration | P1       | Load test: 60s with worst-case scenario      | Extended performance validation   | PERF-001        |
| 4.3b-E2E-005  | E2E         | P1       | Full gameplay session with multiple power-ups| Real-world performance validation | PERF-002        |

**Coverage**: 6 tests (5 integration, 1 e2e)

---

## Test Coverage Summary

### By Level

| Level       | Count | Percentage | Justification                                          |
|-------------|-------|------------|--------------------------------------------------------|
| Unit        | 24    | 57%        | Focus on ProjectileSystem, time scale, and algorithms  |
| Integration | 13    | 31%        | System interactions, regressions, performance          |
| E2E         | 5     | 12%        | User journeys and real-world validation                |

### By Priority

| Priority | Count | Focus Area                                              |
|----------|-------|---------------------------------------------------------|
| P0       | 18    | Critical functionality, performance, architecture       |
| P1       | 16    | Feature completeness, user experience                   |
| P2       | 8     | Edge cases, nice-to-have coverage                       |

### By Risk Mitigation

| Risk ID   | Tests Addressing | Coverage Level    |
|-----------|------------------|-------------------|
| TECH-001  | 11 tests         | Comprehensive     |
| TECH-002  | 8 tests          | Comprehensive     |
| TECH-003  | 6 tests          | Adequate          |
| PERF-001  | 5 tests          | Comprehensive     |
| PERF-002  | 4 tests          | Adequate          |
| DATA-001  | 4 tests          | Adequate          |
| OPS-001   | 3 tests          | Adequate          |

---

## Recommended Execution Order

### Phase 1: Fail Fast (P0 Unit Tests)

**Duration**: ~5 minutes

1. 4.3b-UNIT-001 to 4.3b-UNIT-016 (16 tests)
   - Time scale calculations
   - ProjectileSystem logic
   - Plugin architecture compliance

**Goal**: Catch logic errors before integration

---

### Phase 2: System Integration (P0 Integration Tests)

**Duration**: ~15 minutes

1. 4.3b-INT-001 to 4.3b-INT-019 (19 tests, P0 only)
   - Physics integration
   - Collision detection
   - Rendering pipeline
   - Regression suite

**Goal**: Validate system interactions

---

### Phase 3: Performance Validation (P0 Performance Tests)

**Duration**: ~10 minutes

1. 4.3b-PERF-001 to 4.3b-PERF-004 (4 tests)
   - FPS benchmarks with power-up combinations
   - Memory usage validation

**Goal**: Verify performance requirements met

---

### Phase 4: User Experience (P1 E2E Tests)

**Duration**: ~20 minutes

1. 4.3b-E2E-001 to 4.3b-E2E-005 (5 tests)
   - Player-facing journeys
   - Real-world scenarios

**Goal**: Validate user experience

---

### Phase 5: Comprehensive Coverage (P1+ Tests)

**Duration**: ~30 minutes

1. All remaining P1 and P2 tests
   - Extended coverage
   - Edge cases
   - Nice-to-have scenarios

**Goal**: Complete test suite execution

---

## Test Data Requirements

### Slow Motion Tests

```yaml
test_data:
  initial_time_scale: 1.0
  slow_time_scale: 0.5
  transition_duration: 0.5  # seconds
  effect_duration: 10.0     # seconds
  test_balls: [1, 3, 5]     # number of balls
```

### Laser Gun Tests

```yaml
test_data:
  fire_rate: 2              # shots per second
  fire_interval: 500        # milliseconds
  projectile_speed: 500     # pixels per second
  projectile_size: {width: 4, height: 12}
  effect_duration: 20       # seconds
  pool_size: 20
```

### Performance Tests

```yaml
test_data:
  target_fps_3_powerups: 55
  target_fps_5_powerups: 50
  memory_limit: 250         # MB
  test_duration: 60         # seconds
  power_up_combinations:
    - [shield, pierce, magnet]
    - [shield, pierce, magnet, slow_motion, laser]
```

---

## Test Environment Requirements

### Unit Tests

- **Framework**: Vitest
- **Dependencies**: Minimal mocking
- **Isolation**: True unit tests with no external dependencies
- **Speed**: <100ms per test

### Integration Tests

- **Framework**: Vitest
- **Environment**: jsdom or canvas-mock
- **Dependencies**: Test doubles for Canvas API
- **Speed**: <500ms per test

### E2E Tests

- **Framework**: Playwright
- **Environment**: Real browser (Chromium)
- **Dependencies**: Full game environment
- **Speed**: <5s per test

### Performance Tests

- **Framework**: Vitest + Chrome DevTools
- **Environment**: Real browser with DevTools Protocol
- **Monitoring**: FPS counter, memory profiler
- **Assertions**: Performance.now() timing

---

## Coverage Gap Analysis

### Requirements Fully Covered

✅ AC1: Slow Motion (9 tests)  
✅ AC2: Laser Gun (9 tests)  
✅ AC3: ProjectileSystem (11 tests)  
✅ AC4-8: Integration (8 tests)  
✅ AC10: Critical combinations (6 tests)  
✅ AC11-14: Performance (6 tests)

### Requirements Partially Covered

⚠️ AC9: Unit test coverage (6 explicit tests, but 24 total unit tests provide comprehensive coverage)

### Coverage Gaps

❌ **None identified** - All acceptance criteria have test coverage

---

## Test Maintenance Strategy

### Test Stability

**Unit Tests**: Highly stable (logic-only)  
**Integration Tests**: Moderate (depend on system boundaries)  
**E2E Tests**: Lower stability (UI changes, timing issues)

### Maintenance Triggers

Update tests when:
- Acceptance criteria change
- New power-ups added
- Performance targets adjusted
- Architecture changes

### Test Debt Prevention

- Keep tests atomic and independent
- Use clear naming conventions
- Document complex test scenarios
- Regular test suite review

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels (except defense-in-depth for critical paths)
- [x] Priorities align with risk assessment
- [x] Test IDs follow naming convention (4.3b-LEVEL-SEQ)
- [x] Scenarios are atomic and independent
- [x] Performance tests have specific targets
- [x] Memory tests have clear limits

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 42
  by_level:
    unit: 24
    integration: 13
    e2e: 5
  by_priority:
    p0: 18
    p1: 16
    p2: 8
  coverage_gaps: []
  risk_coverage:
    TECH-001: 11  # ProjectileSystem
    TECH-002: 8   # Time scaling
    TECH-003: 6   # Laser + Multi-ball
    PERF-001: 5   # Slow Motion performance
    PERF-002: 4   # Multiple power-ups
    DATA-001: 4   # Memory leaks
    OPS-001: 3    # Regression
```

---

## Summary

**Test Strategy**: Comprehensive risk-based testing with 42 scenarios

**Key Focus Areas**:
1. ProjectileSystem architecture (11 tests)
2. Time scaling implementation (8 tests)
3. Performance validation (6 dedicated tests)
4. Regression prevention (3 tests)

**Estimated Execution Time**: ~80 minutes for full suite

**Confidence Level**: High - All risks have dedicated test coverage

**Recommendation**: Proceed with test implementation after ProjectileSystem design approval
