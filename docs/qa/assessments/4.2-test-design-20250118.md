# Test Design: Story 4.2 基本パワーアップ実装

**Date**: 2025-01-18  
**Designer**: Quinn (Test Architect)  
**Story**: 4.2 - 基本パワーアップ実装  
**Status**: Draft

## Test Strategy Overview

- **Total test scenarios**: 42
- **Unit tests**: 21 (50%)
- **Integration tests**: 15 (36%)
- **E2E tests**: 6 (14%)
- **Priority distribution**: P0: 12, P1: 18, P2: 10, P3: 2

## Test Scenarios by Acceptance Criteria

### AC1: マルチボール（3個同時）

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|-----------------|
| 4.2-UNIT-001 | Unit | P0 | Ball cloning logic - position/velocity variations | Pure logic for ball duplication | - |
| 4.2-UNIT-002 | Unit | P0 | Ball count limit enforcement (max 3) | Critical boundary validation | PERF-001 |
| 4.2-UNIT-003 | Unit | P1 | Ball removal when out of bounds | Object lifecycle management | TECH-004 |
| 4.2-UNIT-004 | Unit | P1 | Object pool initialization and usage | Memory management logic | PERF-001 |
| 4.2-UNIT-005 | Unit | P2 | Ball velocity calculation after split | Mathematical calculation | - |
| 4.2-UNIT-006 | Unit | P2 | Ball position offset calculation | Pure geometry logic | - |
| 4.2-INT-001 | Integration | P0 | Multi-ball collision detection with blocks | Multi-component interaction | PERF-002 |
| 4.2-INT-002 | Integration | P0 | Multi-ball collision with paddle | Critical game mechanic | - |
| 4.2-INT-003 | Integration | P0 | Performance with 3 balls active | System performance validation | PERF-001 |
| 4.2-INT-004 | Integration | P1 | Ball tracking in GameState | State management verification | TECH-002 |
| 4.2-INT-005 | Integration | P1 | Memory usage with object pooling | Resource management | TECH-004 |
| 4.2-E2E-001 | E2E | P0 | Complete multi-ball gameplay at 60 FPS | Critical performance requirement | PERF-001 |
| 4.2-E2E-002 | E2E | P1 | Multi-ball power-up collection and activation | User journey validation | - |

### AC2: パドルサイズ変更（大/小）

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|-----------------|
| 4.2-UNIT-007 | Unit | P0 | Paddle size multiplier calculation (1.5x, 0.75x) | Pure calculation logic | - |
| 4.2-UNIT-008 | Unit | P0 | Collision box adjustment for resized paddle | Geometry calculation | - |
| 4.2-UNIT-009 | Unit | P1 | Size transition animation timing | Animation logic | - |
| 4.2-UNIT-010 | Unit | P2 | Paddle size limits validation | Boundary conditions | - |
| 4.2-INT-006 | Integration | P0 | Ball-paddle collision with large paddle | Critical game mechanic | - |
| 4.2-INT-007 | Integration | P0 | Ball-paddle collision with small paddle | Critical game mechanic | - |
| 4.2-INT-008 | Integration | P0 | Conflicting size power-ups handling | Complex state management | TECH-001 |
| 4.2-INT-009 | Integration | P1 | Visual feedback for size changes | UI integration | - |
| 4.2-INT-010 | Integration | P2 | Paddle rendering at different sizes | Canvas rendering | - |
| 4.2-E2E-003 | E2E | P1 | Complete gameplay with paddle size changes | User experience validation | - |

### AC3: ボール速度変更（速/遅）

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|-----------------|
| 4.2-UNIT-011 | Unit | P0 | Speed multiplier calculation (1.5x, 0.5x) | Pure calculation | - |
| 4.2-UNIT-012 | Unit | P0 | Physics stability at different speeds | Physics calculations | - |
| 4.2-UNIT-013 | Unit | P1 | Velocity vector normalization | Mathematical logic | - |
| 4.2-UNIT-014 | Unit | P2 | Speed transition smoothing | Animation logic | - |
| 4.2-INT-011 | Integration | P0 | Collision detection at high speed | Critical physics validation | PERF-002 |
| 4.2-INT-012 | Integration | P0 | Collision detection at low speed | Physics edge case | - |
| 4.2-INT-013 | Integration | P1 | Multiple speed modifiers stacking | Complex state | TECH-001 |
| 4.2-INT-014 | Integration | P2 | Frame-rate independent movement | Performance consistency | PERF-001 |
| 4.2-E2E-004 | E2E | P1 | Complete gameplay with speed variations | User experience | BUS-001 |

### Cross-Cutting Concerns

#### Power-Up System Integration

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|-----------------|
| 4.2-UNIT-015 | Unit | P0 | Plugin registration and initialization | Core plugin logic | - |
| 4.2-UNIT-016 | Unit | P1 | Power-up duration management | Time-based logic | - |
| 4.2-UNIT-017 | Unit | P1 | Effect cleanup on expiration | Resource management | TECH-004 |
| 4.2-INT-015 | Integration | P0 | Power-up spawning from blocks | Game loop integration | - |
| 4.2-E2E-005 | E2E | P0 | Multiple power-ups active simultaneously | Complex interaction | TECH-001, TECH-002 |

#### State Management

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|-----------------|
| 4.2-UNIT-018 | Unit | P0 | Active power-ups array management | State logic | TECH-002 |
| 4.2-UNIT-019 | Unit | P1 | Power-up priority system | Conflict resolution logic | TECH-001 |
| 4.2-INT-016 | Integration | P0 | State persistence during pause | State integrity | DATA-001 |
| 4.2-INT-017 | Integration | P1 | State recovery after game over | Error recovery | DATA-001 |

#### Performance & Edge Cases

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|-----------------|
| 4.2-UNIT-020 | Unit | P3 | Edge case: Minimum paddle size boundary | Boundary validation | - |
| 4.2-UNIT-021 | Unit | P3 | Edge case: Maximum ball speed boundary | Boundary validation | - |
| 4.2-E2E-006 | E2E | P0 | Stress test: All power-ups active | System limits | PERF-001, TECH-002 |

## Risk Coverage Matrix

| Risk ID | Risk Description | Test Scenarios |
|---------|------------------|----------------|
| PERF-001 | マルチボールパフォーマンス | 4.2-UNIT-002, 4.2-UNIT-004, 4.2-INT-003, 4.2-INT-005, 4.2-E2E-001, 4.2-INT-014, 4.2-E2E-006 |
| TECH-001 | パワーアップ効果競合 | 4.2-INT-008, 4.2-INT-013, 4.2-UNIT-019, 4.2-E2E-005 |
| TECH-002 | 状態管理複雑化 | 4.2-INT-004, 4.2-UNIT-018, 4.2-E2E-005, 4.2-E2E-006 |
| DATA-001 | ゲーム状態不整合 | 4.2-INT-016, 4.2-INT-017 |
| PERF-002 | 衝突判定計算量 | 4.2-INT-001, 4.2-INT-011 |
| TECH-004 | メモリリーク | 4.2-UNIT-003, 4.2-INT-005, 4.2-UNIT-017 |
| BUS-001 | バランス問題 | 4.2-E2E-004 |

## Recommended Execution Order

### Phase 1: Critical Path (P0 Unit Tests)
1. 4.2-UNIT-001 - Ball cloning logic
2. 4.2-UNIT-002 - Ball count limit
3. 4.2-UNIT-007 - Paddle size calculation
4. 4.2-UNIT-008 - Collision box adjustment
5. 4.2-UNIT-011 - Speed multiplier
6. 4.2-UNIT-012 - Physics stability
7. 4.2-UNIT-015 - Plugin registration
8. 4.2-UNIT-018 - Power-ups array management

### Phase 2: Integration Validation (P0 Integration)
1. 4.2-INT-001 - Multi-ball collision with blocks
2. 4.2-INT-002 - Multi-ball collision with paddle
3. 4.2-INT-003 - Performance with 3 balls
4. 4.2-INT-006 - Large paddle collision
5. 4.2-INT-007 - Small paddle collision
6. 4.2-INT-008 - Conflicting size power-ups
7. 4.2-INT-011 - High-speed collision
8. 4.2-INT-012 - Low-speed collision
9. 4.2-INT-015 - Power-up spawning
10. 4.2-INT-016 - State during pause

### Phase 3: End-to-End Validation (P0 E2E)
1. 4.2-E2E-001 - Multi-ball at 60 FPS
2. 4.2-E2E-005 - Multiple power-ups simultaneously
3. 4.2-E2E-006 - Stress test all power-ups

### Phase 4: P1 Tests (Critical Features)
Execute all P1 tests in order of dependency

### Phase 5: P2 Tests (Secondary Features)
Execute P2 tests as time permits

### Phase 6: P3 Tests (Edge Cases)
Execute if all other tests pass and time available

## Test Data Requirements

### Performance Benchmarks
- FPS target: 60 FPS minimum
- Memory limit: 200MB maximum
- Response time: <16ms per frame

### Test Configurations
- **Minimum spec**: 2GB RAM, integrated graphics
- **Target spec**: 4GB RAM, discrete graphics
- **Stress test**: Maximum effects, 1 hour duration

### Power-Up Parameters
- Multi-ball: 3 balls maximum
- Paddle large: 1.5x size
- Paddle small: 0.75x size
- Ball fast: 1.5x speed
- Ball slow: 0.5x speed
- Duration: 10 seconds default

## Coverage Analysis

### Acceptance Criteria Coverage
- AC1 (マルチボール): 13 tests ✓
- AC2 (パドルサイズ): 10 tests ✓
- AC3 (ボール速度): 9 tests ✓
- Cross-cutting: 10 tests ✓

### Risk Mitigation Coverage
- All Critical risks: Covered ✓
- All High risks: Covered ✓
- Medium risks: Partially covered
- Low risks: Basic coverage

### Test Level Distribution (Pyramid Compliance)
- Unit: 50% (Target: 60%) ⚠️
- Integration: 36% (Target: 30%) ⚠️
- E2E: 14% (Target: 10%) ⚠️

*Note: Higher integration test percentage justified due to complex component interactions*

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (shift-left applied)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent
- [x] Critical risks have multiple test coverage
- [x] Performance requirements explicitly tested