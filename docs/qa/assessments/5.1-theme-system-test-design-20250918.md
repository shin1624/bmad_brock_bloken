# Test Design: Story 5.1 テーマシステム

Date: 2025-09-18  
Reviewer: Quinn (Test Architect)  
Story: 5.1 - Theme System Implementation

## Test Strategy Overview

リスクプロファイルに基づき、Critical/High リスクに対する包括的なテスト戦略を策定しました。

### Testing Pyramid Distribution
- **Unit Tests (60%)**: 個別テーマ設定、プラグイン機能、状態管理
- **Integration Tests (30%)**: React-Canvas統合、テーマ切り替え、永続化
- **E2E Tests (10%)**: 完全なユーザーワークフロー、パフォーマンス検証

## Test Scenarios by Acceptance Criteria

### AC1: ネオンテーマ実装

#### Unit Tests
```typescript
describe('NeonTheme', () => {
  it('should export valid ThemeConfig with neon color scheme', () => {
    // Verify color values, gradients, glow effects
  });
  
  it('should include neon-specific visual properties', () => {
    // Check for bloom, glow radius, neon colors
  });
  
  it('should maintain contrast ratios for accessibility', () => {
    // WCAG AA compliance for text/background
  });
});
```

#### Integration Tests
```typescript
describe('NeonTheme Canvas Integration', () => {
  it('should apply neon colors to game entities', () => {
    // Verify ball, paddle, blocks use neon palette
  });
  
  it('should render glow effects on Canvas', () => {
    // Check shadowBlur, shadowColor application
  });
});
```

### AC2: ピクセルテーマ実装

#### Unit Tests
```typescript
describe('PixelTheme', () => {
  it('should export valid ThemeConfig with pixel art styling', () => {
    // Verify pixelated rendering settings
  });
  
  it('should disable anti-aliasing for pixel perfect rendering', () => {
    // Check imageSmoothingEnabled = false
  });
});
```

### AC3: シンセウェーブテーマ実装

#### Unit Tests
```typescript
describe('SynthwaveTheme', () => {
  it('should include 80s color palette', () => {
    // Purple, pink, cyan color verification
  });
  
  it('should define gradient backgrounds', () => {
    // Verify linear/radial gradient definitions
  });
});
```

### AC4: ミニマルテーマ実装

#### Unit Tests
```typescript
describe('MinimalTheme', () => {
  it('should use limited color palette', () => {
    // Max 3-4 colors verification
  });
  
  it('should exclude complex visual effects', () => {
    // No gradients, shadows, or animations
  });
});
```

### AC5: リアルタイム切り替え

#### Critical Performance Tests
```typescript
describe('Theme Switching Performance', () => {
  it('should complete theme switch within 16ms', async () => {
    const startTime = performance.now();
    await themeManager.switchTheme('neon');
    const duration = performance.now() - startTime;
    expect(duration).toBeLessThan(16);
  });
  
  it('should maintain 60 FPS during theme switch', async () => {
    const fps = await measureFPSDuringThemeSwitch();
    expect(fps).toBeGreaterThanOrEqual(60);
  });
  
  it('should not cause memory leaks on repeated switches', async () => {
    const initialMemory = performance.memory.usedJSHeapSize;
    for (let i = 0; i < 100; i++) {
      await themeManager.switchTheme(themes[i % 4]);
    }
    const finalMemory = performance.memory.usedJSHeapSize;
    expect(finalMemory - initialMemory).toBeLessThan(5_000_000); // 5MB tolerance
  });
});
```

#### Integration Tests
```typescript
describe('Theme State Management', () => {
  it('should persist theme selection to LocalStorage', () => {
    uiStore.setTheme('synthwave');
    expect(localStorage.getItem('selectedTheme')).toBe('synthwave');
  });
  
  it('should restore theme on app initialization', () => {
    localStorage.setItem('selectedTheme', 'pixel');
    const store = createUIStore();
    expect(store.selectedTheme).toBe('pixel');
  });
  
  it('should fallback to default theme on invalid selection', () => {
    uiStore.setTheme('invalid-theme');
    expect(uiStore.selectedTheme).toBe('neon'); // default
  });
});
```

## Risk-Based Test Cases

### PERF-001: リアルタイムテーマ切り替え遅延 (Critical)

#### Test Suite: Performance Critical Path
```typescript
describe('Critical Performance: Theme Switching', () => {
  beforeEach(() => {
    // Setup game in active state with entities
    setupActiveGameState();
  });
  
  test('P1: Theme switch during active gameplay', async () => {
    const metrics = await profileThemeSwitch({
      fromTheme: 'neon',
      toTheme: 'pixel',
      duringGameplay: true
    });
    
    expect(metrics.switchDuration).toBeLessThan(16);
    expect(metrics.framesDropped).toBe(0);
    expect(metrics.visualArtifacts).toBe(false);
  });
  
  test('P1: Rapid consecutive theme switches', async () => {
    const results = await rapidThemeSwitchTest(10); // 10 switches
    
    expect(results.averageDuration).toBeLessThan(16);
    expect(results.memoryLeaked).toBe(false);
    expect(results.crashed).toBe(false);
  });
  
  test('P1: Theme switch with maximum entities', async () => {
    spawnMaximumEntities(); // Worst case scenario
    
    const duration = await measureThemeSwitch();
    expect(duration).toBeLessThan(20); // Slightly relaxed for stress
  });
});
```

### TECH-001: Canvasレンダリングパフォーマンス劣化 (High)

#### Test Suite: Canvas Rendering Performance
```typescript
describe('Canvas Performance with Themes', () => {
  test.each(['neon', 'pixel', 'synthwave', 'minimal'])(
    'P2: Maintains 60 FPS with %s theme',
    async (theme) => {
      await themeManager.switchTheme(theme);
      const fps = await measureAverageFPS(5000); // 5 seconds
      
      expect(fps).toBeGreaterThanOrEqual(58); // 3% tolerance
    }
  );
  
  test('P2: Theme rendering with all PowerUps active', async () => {
    activateAllPowerUps();
    
    for (const theme of themes) {
      await themeManager.switchTheme(theme);
      const fps = await measureAverageFPS(1000);
      expect(fps).toBeGreaterThanOrEqual(55); // 8% tolerance under load
    }
  });
});
```

## Test Data Requirements

### Theme Configuration Test Data
```javascript
const testThemeConfigs = {
  valid: {
    minimal: { colors: ['#000', '#fff'], effects: [] },
    complex: { colors: [...], gradients: [...], effects: [...] }
  },
  invalid: {
    missingColors: { effects: [] }, // Missing required field
    invalidColorFormat: { colors: ['not-a-color'] },
    tooManyColors: { colors: new Array(100).fill('#000') }
  }
};
```

### Performance Test Profiles
```javascript
const performanceProfiles = {
  minimal: { entities: 10, effects: false },
  normal: { entities: 50, effects: true },
  stress: { entities: 200, effects: true, powerUps: 10 }
};
```

## Test Environment Requirements

### Browser Requirements
- Chrome 90+ (primary testing)
- Firefox 88+ (secondary)
- Safari 14+ (compatibility)
- Hardware acceleration enabled

### Performance Testing Tools
- Chrome DevTools Performance Profiler
- Lighthouse CI for automated performance
- Custom FPS monitoring utility
- Memory leak detector

### Visual Testing Tools
- Percy.io or Chromatic for visual regression
- Manual review checklist for theme quality

## Test Execution Schedule

### Phase 1: Unit Tests (Day 1-2)
- Individual theme configurations
- Plugin interface compliance
- State management logic

### Phase 2: Integration Tests (Day 3-4)
- React-Canvas bridge testing
- Theme persistence and restoration
- Plugin system integration

### Phase 3: Performance Tests (Day 5)
- Critical path performance validation
- FPS monitoring under various conditions
- Memory leak detection

### Phase 4: E2E Tests (Day 6)
- Complete user workflows
- Cross-browser compatibility
- Visual regression tests

## Test Automation Strategy

### CI/CD Pipeline Integration
```yaml
test:themes:
  stage: test
  script:
    - npm run test:unit -- --grep "Theme"
    - npm run test:integration -- --grep "Theme"
    - npm run test:performance -- --grep "PERF-001|TECH-001"
  artifacts:
    reports:
      - performance-report.json
      - coverage/theme-coverage.html
```

### Automated Performance Monitoring
```javascript
// Performance regression detection
const performanceBaseline = {
  themeSwitch: 15, // ms
  averageFPS: 60,
  memoryDelta: 1000000 // 1MB
};

// Alert if performance degrades >10%
```

## Success Criteria

### Must Pass (Gate: FAIL if not met)
- [ ] All Critical risk tests pass (PERF-001)
- [ ] Theme switching < 16ms in normal conditions
- [ ] 60 FPS maintained across all themes
- [ ] No memory leaks detected

### Should Pass (Gate: CONCERNS if not met)
- [ ] All High risk tests pass (TECH-001)
- [ ] Visual quality consistent across themes
- [ ] Theme persistence works reliably
- [ ] Plugin integration stable

### Nice to Pass (Gate: PASS with notes)
- [ ] All Medium/Low risk tests pass
- [ ] Performance under extreme stress
- [ ] Cross-browser pixel-perfect rendering

## Test Report Template

```markdown
## Theme System Test Report

### Test Execution Summary
- Total Tests: XX
- Passed: XX
- Failed: XX
- Skipped: XX
- Coverage: XX%

### Critical Path Results
- Theme Switch Performance: XX ms (Target: <16ms)
- Average FPS: XX (Target: 60)
- Memory Usage: XX MB (Target: <200MB)

### Risk Mitigation Status
- PERF-001: [PASSED/FAILED] - Details
- TECH-001: [PASSED/FAILED] - Details

### Recommendations
- [Specific improvements needed]
- [Performance optimizations required]
- [Follow-up testing needed]
```

## Appendix: Test Utilities

### Performance Measurement Helper
```javascript
class ThemePerformanceProfiler {
  async measureThemeSwitch(from, to) {
    const marks = [];
    
    performance.mark('theme-switch-start');
    await themeManager.switchTheme(to);
    performance.mark('theme-switch-end');
    
    performance.measure('theme-switch', 
      'theme-switch-start', 
      'theme-switch-end'
    );
    
    const measure = performance.getEntriesByName('theme-switch')[0];
    return measure.duration;
  }
  
  async profileFPS(duration) {
    const frames = [];
    let lastTime = performance.now();
    
    const measure = () => {
      const now = performance.now();
      const fps = 1000 / (now - lastTime);
      frames.push(fps);
      lastTime = now;
      
      if (now < startTime + duration) {
        requestAnimationFrame(measure);
      }
    };
    
    const startTime = performance.now();
    requestAnimationFrame(measure);
    
    await new Promise(resolve => setTimeout(resolve, duration));
    return frames.reduce((a, b) => a + b) / frames.length;
  }
}
```