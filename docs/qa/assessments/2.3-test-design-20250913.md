# Test Design: Story 2.3 - ブロックシステム

**Date**: 2025-09-13  
**Designer**: Quinn (Test Architect)  
**Story Status**: Draft

## Test Strategy Overview

- **Total test scenarios**: 42
- **Unit tests**: 24 (57%)
- **Integration tests**: 12 (29%)
- **E2E tests**: 6 (14%)
- **Priority distribution**: P0: 18, P1: 16, P2: 6, P3: 2

## Test Scenarios by Acceptance Criteria

### AC1: グリッドベースのブロック配置（10列×8行）

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.3-UNIT-001 | Unit | P1 | GridLayout計算検証 | Pure logic - グリッド数学的計算 |
| 2.3-UNIT-002 | Unit | P1 | ブロック座標計算正確性 | Algorithm - 位置計算とスペーシング |
| 2.3-UNIT-003 | Unit | P2 | 境界ブロック配置検証 | Edge case - グリッド端でのブロック位置 |
| 2.3-INT-001 | Integration | P1 | BlockManager-Canvas統合 | Multi-component - レンダリングパイプライン |
| 2.3-E2E-001 | E2E | P1 | 視覚的グリッド検証 | User-facing - グリッド表示の視覚的確認 |

### AC2: 複数のブロックタイプ（Normal, Hard, Indestructible）

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.3-UNIT-004 | Unit | P0 | BlockType enum検証 | Data integrity - 型安全性保証 |
| 2.3-UNIT-005 | Unit | P0 | Normal ブロック破壊ロジック | Core logic - 1ヒット破壊検証 |
| 2.3-UNIT-006 | Unit | P0 | Hard ブロック破壊ロジック | Core logic - 2ヒット破壊検証 |
| 2.3-UNIT-007 | Unit | P0 | Indestructible ブロック検証 | Core logic - 破壊不可処理 |
| 2.3-UNIT-008 | Unit | P0 | スコア計算正確性 | Business logic - 100/200点計算 |
| 2.3-INT-002 | Integration | P0 | ブロック-Ball衝突処理 | Critical path - ゲーム核心機能 |
| 2.3-INT-003 | Integration | P1 | BlockManager状態更新 | Component interaction - 状態管理同期 |
| 2.3-E2E-002 | E2E | P0 | ブロック破壊ゲームプレイ | Revenue-critical - コアユーザージャーニー |

### AC3: ヒットポイントシステム（視覚的フィードバック）

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.3-UNIT-009 | Unit | P1 | HP初期化検証 | State management - HP設定ロジック |
| 2.3-UNIT-010 | Unit | P1 | HP減算処理 | State management - ダメージ計算 |
| 2.3-UNIT-011 | Unit | P2 | HP境界値処理 | Edge case - 0以下HP処理 |
| 2.3-INT-004 | Integration | P1 | HP-視覚フィードバック連携 | UI integration - 視覚的状態表示 |
| 2.3-E2E-003 | E2E | P1 | ブロック損傷視覚確認 | User experience - 視覚的フィードバック |

### AC4: 破壊エフェクト（パーティクル生成）

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.3-UNIT-012 | Unit | P0 | Particleクラス物理計算 | Core logic - パーティクル物理 |
| 2.3-UNIT-013 | Unit | P0 | ObjectPool取得/解放 | Memory management - メモリリーク防止 |
| 2.3-UNIT-014 | Unit | P0 | パーティクル寿命管理 | Memory management - 0.5秒後解放 |
| 2.3-UNIT-015 | Unit | P1 | パーティクル初期速度計算 | Physics - 爆発エフェクト物理 |
| 2.3-UNIT-016 | Unit | P1 | 重力・減衰計算 | Physics - リアルな物理動作 |
| 2.3-INT-005 | Integration | P0 | ParticleSystem-EventBus統合 | Critical path - 破壊イベント処理 |
| 2.3-INT-006 | Integration | P0 | パーティクル-レンダリング統合 | Performance critical - 描画パフォーマンス |
| 2.3-INT-007 | Integration | P1 | ObjectPool枯渇処理 | Error handling - プール不足時対応 |
| 2.3-E2E-004 | E2E | P1 | パーティクルエフェクト視覚確認 | User experience - エフェクト品質 |

### AC5: スコア計算とコンボシステム

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.3-UNIT-017 | Unit | P0 | 基本スコア計算 | Business logic - 100/200点計算 |
| 2.3-UNIT-018 | Unit | P0 | コンボ倍率計算 | Business logic - コンボボーナス |
| 2.3-UNIT-019 | Unit | P1 | コンボリセット処理 | Business logic - コンボ継続条件 |
| 2.3-UNIT-020 | Unit | P2 | スコア上限処理 | Edge case - 最大スコア制限 |
| 2.3-UNIT-021 | Unit | P2 | 負のスコア防止 | Edge case - スコア下限保護 |
| 2.3-INT-008 | Integration | P0 | ScoreManager-EventBus統合 | Critical path - スコア更新イベント |
| 2.3-INT-009 | Integration | P1 | スコア-UI同期 | User experience - スコア表示更新 |
| 2.3-E2E-005 | E2E | P0 | スコア加算ゲームプレイ | Revenue-critical - スコア機能検証 |

## Performance and Load Testing

### パフォーマンステスト（追加シナリオ）

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.3-UNIT-022 | Unit | P0 | パーティクルプール性能 | Performance - メモリ効率検証 |
| 2.3-UNIT-023 | Unit | P1 | 衝突検出アルゴリズム性能 | Performance - 80ブロック処理 |
| 2.3-UNIT-024 | Unit | P2 | ガベージコレクション最適化 | Performance - メモリ解放効率 |
| 2.3-INT-010 | Integration | P0 | 60FPS維持テスト | Performance critical - フレームレート |
| 2.3-INT-011 | Integration | P0 | メモリリークテスト | Performance critical - 長時間動作 |
| 2.3-INT-012 | Integration | P1 | 大量パーティクル負荷テスト | Performance - 同時生成負荷 |
| 2.3-E2E-006 | E2E | P1 | 長時間プレイ性能テスト | User experience - 持続可能性 |

## Risk Coverage Mapping

### Critical Risk Tests (対PERF-001: パーティクルメモリリーク)
- **2.3-UNIT-013**: ObjectPool取得/解放
- **2.3-UNIT-014**: パーティクル寿命管理
- **2.3-INT-011**: メモリリークテスト
- **2.3-E2E-006**: 長時間プレイ性能テスト

### High Risk Tests (対PERF-002, TECH-001)
- **2.3-UNIT-023**: 衝突検出アルゴリズム性能
- **2.3-INT-010**: 60FPS維持テスト
- **2.3-INT-002**: ブロック-Ball衝突処理

### Medium Risk Tests (対DATA-001, TECH-002, BUS-001)
- **2.3-UNIT-004**: BlockType enum検証
- **2.3-UNIT-018**: コンボ倍率計算
- **2.3-INT-008**: ScoreManager-EventBus統合

## Test Data Requirements

### Unit Test Data
```typescript
// ブロック設定テストデータ
const testBlockConfigs = {
  normal: { type: 'normal', maxHP: 1, score: 100 },
  hard: { type: 'hard', maxHP: 2, score: 200 },
  indestructible: { type: 'indestructible', maxHP: Infinity, score: 0 }
};

// グリッドテストデータ
const testGrids = {
  standard: { columns: 10, rows: 8, cellWidth: 75, cellHeight: 25 },
  boundary: { columns: 1, rows: 1 },
  maximum: { columns: 20, rows: 16 }
};

// パーティクル設定テストデータ
const testParticleConfigs = {
  explosion: { count: 8, lifespan: 0.5, velocity: { x: 100, y: 100 } },
  minimal: { count: 1, lifespan: 0.1 },
  maximum: { count: 50, lifespan: 2.0 }
};
```

### Integration Test Environment
- **In-Memory Canvas**: 軽量レンダリング環境
- **Mock EventBus**: イベント配信テスト用
- **Performance Timer**: フレームレート測定
- **Memory Monitor**: メモリ使用量追跡

### E2E Test Environment
- **Test Browser**: Headless Chrome with performance monitoring
- **Game Canvas**: 800x600 resolution
- **Input Simulation**: Mouse/keyboard interaction
- **Visual Regression**: Screenshot comparison

## Test Execution Strategy

### Phase 1: P0 Critical Tests (必須)
1. **Unit Tests P0** (13 tests) - 実行時間: ~30秒
   - ブロック破壊ロジック検証
   - パーティクルメモリ管理
   - スコア計算正確性

2. **Integration Tests P0** (6 tests) - 実行時間: ~2分
   - 衝突検出統合
   - パーティクルシステム統合
   - スコア管理統合

3. **E2E Tests P0** (3 tests) - 実行時間: ~5分
   - コアゲームプレイ検証
   - スコア加算確認

### Phase 2: P1 Core Tests (推奨)
- **Unit Tests P1** (9 tests) - 実行時間: ~45秒
- **Integration Tests P1** (6 tests) - 実行時間: ~3分  
- **E2E Tests P1** (3 tests) - 実行時間: ~8分

### Phase 3: P2/P3 Extended Tests (時間があれば)
- 境界値テスト
- エラーハンドリング
- UI/UX品質確認

## Recommended Execution Order

### Development Phase
1. **Unit Tests**: 即座のフィードバック
2. **Integration Tests**: コンポーネント相互作用確認
3. **E2E Tests**: エンドユーザー体験検証

### CI/CD Pipeline
1. **Pre-commit**: P0 Unit tests のみ (fail fast)
2. **Pull Request**: P0 + P1 全てのレベル
3. **Release**: 全テスト + パフォーマンス監視

### Performance Gates
- **Unit Tests**: 各テスト <100ms
- **Integration Tests**: 各テスト <30秒
- **E2E Tests**: フルスイート <15分
- **Memory Usage**: テスト後 <50MB残留

## Test Environment Matrix

| Test Level | Environment | Execution Time | Memory Budget |
|------------|-------------|----------------|---------------|
| Unit | Jest/Vitest | <5 minutes | <100MB |
| Integration | Test Container | <10 minutes | <200MB |
| E2E | Staging-like | <20 minutes | <500MB |

## Quality Gates

### Green Gate (PASS)
- 100% P0 tests passing
- 95% P1 tests passing
- Memory usage <200MB
- 60FPS maintained in E2E tests

### Yellow Gate (CONCERNS)  
- 90% P0 tests passing
- Performance tests show warnings
- Some P1 tests failing

### Red Gate (FAIL)
- Any P0 test failing
- Memory leak detected
- Critical performance failure (<30FPS)

## Coverage Goals

### Test Coverage Targets
- **Unit Test Coverage**: >90% for core logic
- **Integration Coverage**: >80% for component interactions  
- **E2E Coverage**: 100% of critical user paths
- **Risk Coverage**: 100% of high-risk scenarios

### Code Coverage Tracking
```typescript
// 最小カバレッジ要件
const coverageThresholds = {
  'src/game/entities/Block.ts': 95,
  'src/game/systems/ParticleSystem.ts': 90,
  'src/game/systems/BlockManager.ts': 90,
  'src/game/systems/ScoreManager.ts': 85
};
```

## Test Maintenance Strategy

### Automated Maintenance
- Test data generators for consistent scenarios
- Snapshot testing for UI regression detection
- Performance baseline tracking
- Flaky test detection and quarantine

### Manual Review Cycles
- Monthly test effectiveness review
- Quarterly test priority reassessment  
- Post-incident test gap analysis
- User feedback integration into test scenarios